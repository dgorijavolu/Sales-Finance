<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financial Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- SheetJS (for Excel parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>

  <!--  MSAL.js for authentication Microsoft Graph API -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>   
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">   
  
  <!-- Centralized Configuration -->
  <script src="config.js"></script>  <style>
    /* Header styles */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      color: #FFFFFF;
    }

    .header-logo i {
      font-size: 20px;
      color: #3498db;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #FFFFFF;
      font-size: 14px;
    }

    .user-info i {
      color: #3498db;
    }

    .sign-in-btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sign-in-btn:hover {
      background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .sign-in-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .sign-out-btn {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .sign-out-btn:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
      transform: translateY(-1px);
    }

    /* THEME: Forest & Amber (Dark Mode) */
    body {
      margin: 0;
      padding-top: 60px; /* Added padding for fixed header */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1A2226;
      color: #D1D5DB;
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      padding: 20px;
      background-color: #263138;
      justify-content: space-between;
      flex-wrap: wrap;
      align-items: center;
      border-bottom: 1px solid #4B5563;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    select {
      background-color: #374151;
      color: #E5E7EB;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #4B5563;
      cursor: pointer;
      min-width: 120px;
    }

    .upload-btn {
      background-color: #F59E0B;
      color: #1F2937;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .upload-btn:hover {
      background-color: #D97706;
    }

    input[type="file"] {
      display: none;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 20px;
    }

    .card {
      background-color: #263138;
      border-radius: 12px;
      padding: 20px;
      min-height: 600px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border: 1px solid #4B5563;
      overflow: hidden;
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #F9FAFB;
    }

    .card h3 {
      font-size: 32px;
      margin-bottom: 5px;
      color: #F59E0B;
    }

    #totalSalesYear, #totalSalesMonth, #outstandingTotal, #totalCharges, #activeClientsPeriod {
        cursor: pointer;
        transition: color 0.2s ease-in-out, text-decoration 0.2s ease-in-out;
    }
    #totalSalesYear:hover, #totalSalesMonth:hover, #outstandingTotal:hover, #totalCharges:hover, #activeClientsPeriod:hover {
        color: #FBBF24;
        text-decoration: underline;
    }

    .subheader {
      font-size: 14px;
      color: #9CA3AF;
      margin-bottom: 5px;
    }

    .highlight {
      color: #34D399 !important;
      font-size: 13px;
    }

    .down {
      color: #F87171 !important;
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px;
      table-layout: fixed;
    }
    
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #4B5563;
      color: #D1D5DB;
      text-align: left;
      white-space: normal;
      word-break: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      padding: 6px 8px;
      border-bottom: 2px solid #4B5563;
      color: #E5E7EB;
      font-weight: 600;
      text-align: left;
      background-color: #374151;
    }

    .card table th:first-child, .card table td:first-child { text-align: left; width: 50%; }
    .card table th:nth-child(2), .card table td:nth-child(2) { text-align: right; width: 50%; }
    .card table th:nth-child(3), .card table td:nth-child(3) { text-align: right; width: 30%; }

    canvas { margin-top: 10px; max-height: 200px; }

    @media (max-width: 1200px) { .dashboard { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } .card { min-height: auto; } .filter-bar { flex-direction: column; align-items: stretch; } .filter-group { margin-bottom: 10px; width: 100%; justify-content: space-between; } .filter-group label { display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px; } select { width: 50%; } .upload-btn { margin-top: 10px; width: 100%; text-align: center; } }

    .popup-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
    .popup-content { background-color: #263138; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); width: 90%; max-width: 950px; max-height: 90vh; display: flex; flex-direction: column; color: #D1D5DB; }
    .popup-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4B5563; padding-bottom: 10px; margin-bottom: 15px; }
    .popup-header h4 { margin: 0; font-size: 18px; color: #F9FAFB; }
    .popup-summary { font-size: 14px; color: #9CA3AF; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #4B5563; }
    .popup-close-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: #9CA3AF; cursor: pointer; padding: 0 5px; line-height: 1; }
    .popup-close-btn:hover { color: #E5E7EB; }
    .popup-body { overflow-y: auto; flex-grow: 1; min-height: 100px; }
    .popup-body table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 0; table-layout: fixed; }
    .popup-body thead th { background-color: #374151 !important; color: #F9FAFB; font-weight: 600; position: sticky; top: 0; z-index: 1; border-bottom: 2px solid #4B5563; }
    .popup-body td.numeric, .popup-body th.numeric { text-align: right; }

    #invoiceChartDetailsTableBody th:nth-child(1), #invoiceChartDetailsTableBody td:nth-child(1) { width: 15%; } #invoiceChartDetailsTableBody th:nth-child(2), #invoiceChartDetailsTableBody td:nth-child(2) { width: 35%; } #invoiceChartDetailsTableBody th:nth-child(3), #invoiceChartDetailsTableBody td:nth-child(3) { width: 15%; } #invoiceChartDetailsTableBody th:nth-child(4), #invoiceChartDetailsTableBody td:nth-child(4) { width: 15%; text-align: right;} #invoiceChartDetailsTableBody th:nth-child(5), #invoiceChartDetailsTableBody td:nth-child(5) { width: 10%; } #invoiceChartDetailsTableBody th:nth-child(6), #invoiceChartDetailsTableBody td:nth-child(6) { width: 10%; }
    #fySalesClientTableBody th:first-child, #fySalesClientTableBody td:first-child, #monthSalesClientTableBody th:first-child, #monthSalesClientTableBody td:first-child { width: 60%; } #fySalesClientTableBody th:nth-child(2), #fySalesClientTableBody td:nth-child(2), #monthSalesClientTableBody th:nth-child(2), #monthSalesClientTableBody td:nth-child(2) { width: 40%; text-align: right; }
    #chargesDetailsTableBody th:nth-child(1), #chargesDetailsTableBody td:nth-child(1) { width: 50%; } #chargesDetailsTableBody th:nth-child(2), #chargesDetailsTableBody td:nth-child(2) { width: 25%; } #chargesDetailsTableBody th:nth-child(3), #chargesDetailsTableBody td:nth-child(3) { width: 25%; text-align: right; }
    .no-data-message { text-align: center; padding: 20px; color: #9CA3AF; font-style: italic; }
  </style>
</head>

<body>
  <!-- Top Header with Sign In -->
  <div class="top-header">
    <div class="header-left">
      <!-- Removed redundant Finance Dashboard title -->
    </div>
    <div class="header-right">
      <div id="userInfo" class="user-info" style="display: none;">
        <i class="fas fa-user"></i>
        <span id="userName">User</span>
      </div>
      <button id="signInBtn" class="sign-in-btn" onclick="globalSignIn()">
        <i class="fas fa-sign-in-alt"></i>
        Sign In
      </button>
      <button id="signOutBtn" class="sign-out-btn" onclick="globalSignOut()" style="display: none;">
        <i class="fas fa-sign-out-alt"></i>
        Sign Out
      </button>
    </div>
  </div>

  <!-- Filter Slicers -->
  <div class="filter-bar">
    <div class="filter-group">
      <label> Financial Year: <select id="year"><option value="">All Years</option></select> </label>
      <label> Month: <select id="month"><option value="">All Months</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option></select></label>
    </div>
    <div><button onclick="signIn()" class="upload-btn">Get Data</button></div>
    <!-- <div> <label for="file-upload" class="upload-btn">Upload Excel</label> <input type="file" id="file-upload" accept=".xlsx,.xls" /> </div> -->
  </div>

  <!-- Dashboard -->
  <div class="dashboard">
    <div class="card">
      <h2>Sales (Financial Year)</h2><div class="subheader">This Fin. Year</div><h3 id="totalSalesYear">$0</h3><p id="salesVsLastYear" class="highlight">▲ $0 vs last FY</p>
      <div class="subheader">Selected Month</div><h3 id="totalSalesMonth">$0</h3><p id="salesVsLastMonth" class="down">▼ $0 vs last month</p>
      <h2>Sales by Customer (Period)</h2><table><thead><tr><th>Customer</th><th class="numeric">Amount</th></tr></thead><tbody id="salesByCustomerTable"></tbody></table>
    </div>
    <div class="card">
      <h2>Cash Flow (Period)</h2><h3 id="cashFlowTotalPeriod">$0</h3><table><thead><tr><th>Customer</th><th class="numeric">Received</th></tr></thead><tbody id="cashFlowCustomerTable"></tbody></table>
      <h2>Total Outstanding (Period)</h2><h3 id="outstandingTotal">$0</h3><p id="avgAgeing" class="highlight">Avg Age: 0 days</p>
      <h2>Softex vs BRC (Period)</h2><canvas id="invoiceChart"></canvas>
    </div>
    <div class="card">
      <h2>Active Clients (Period)</h2><h3 id="activeClientsPeriod">0</h3><h2>Total vs Active Clients (Historical vs Period)</h2><canvas id="activeClientsChart"></canvas>
      <h2>Top 5 Revenue Contributors </h2><table><thead><tr><th>Account</th><th class="numeric">Revenue</th><th class="numeric">% Contrib</th></tr></thead><tbody id="topRevenueTable"></tbody></table>
    </div>
    <div class="card">
      <h2>Total Charges (Period)</h2><h3 id="totalCharges">$0</h3><h2>Sales by Subsidiaries (Period)</h2><canvas id="subsidiariesChart"></canvas>
      <h2>Outstanding by Client </h2>
      <table><thead><tr><th>Account</th><th class="numeric">Total Due ($)</th></tr></thead><tbody id="outstandingByClientTable"></tbody></table>
    </div>
  </div>

  <!-- Popup Modals -->
  <div id="fySalesClientPopup" class="popup-container"><div class="popup-content"><div class="popup-header"><h4 id="fySalesPopupTitle">Client-wise Sales (Financial Year)</h4><button class="popup-close-btn">&times;</button></div><div class="popup-summary"></div><div class="popup-body"><table><thead><tr><th>Customer</th><th class="numeric">Total Sales</th></tr></thead><tbody id="fySalesClientTableBody"></tbody></table></div></div></div>
  <div id="monthSalesClientPopup" class="popup-container"><div class="popup-content"><div class="popup-header"><h4 id="monthSalesPopupTitle">Client-wise Sales (Month)</h4><button class="popup-close-btn">&times;</button></div><div class="popup-summary"></div><div class="popup-body"><table><thead><tr><th>Customer</th><th class="numeric">Total Sales</th></tr></thead><tbody id="monthSalesClientTableBody"></tbody></table></div></div></div>
  <div id="periodOutstandingPopup" class="popup-container"><div class="popup-content"><div class="popup-header"><h4 id="periodOutstandingPopupTitle">Outstanding Invoice Details (Period)</h4><button class="popup-close-btn">&times;</button></div><div class="popup-summary"></div><div id="periodOutstandingTableContainer" class="popup-body"></div></div></div>
  <div id="chargesDetailsPopup" class="popup-container"><div class="popup-content"><div class="popup-header"><h4 id="chargesDetailsPopupTitle">Charges Details (Period)</h4><button class="popup-close-btn">&times;</button></div><div class="popup-summary"></div><div class="popup-body"><table><thead><tr><th>Customer</th><th>Inv. Date</th><th class="numeric">Charge Amount</th></tr></thead><tbody id="chargesDetailsTableBody"></tbody></table></div></div></div>
  <div id="invoiceChartDetailsPopup" class="popup-container"><div class="popup-content"><div class="popup-header"><h4 id="invoiceChartDetailsPopupTitle">Details (Period)</h4><button class="popup-close-btn">&times;</button></div><div class="popup-summary"></div><div class="popup-body"><table><thead><tr><th>Inv. No</th><th>Customer</th><th>Inv. Date</th><th class="numeric">Inv. Value</th><th>Softex No</th><th>BRC No</th></tr></thead><tbody id="invoiceChartDetailsTableBody"></tbody></table></div></div></div>
  <div id="activeClientsPopup" class="popup-container"><div class="popup-content"><div class="popup-header"><h4 id="activeClientsPopupTitle">Active Clients (Period)</h4><button class="popup-close-btn">&times;</button></div><div class="popup-summary"></div><div class="popup-body"><table><thead><tr><th>Client Name</th></tr></thead><tbody id="activeClientsTableBody"></tbody></table></div></div></div>


  <script>
  // Global authentication variables (shared with softex-brc.html)
  let globalAuth = {
    isAuthenticated: false,
    accessToken: null,
    account: null,
    userName: null
  };

  // Authentication state key for localStorage (shared key)
  const AUTH_STATE_KEY = 'finance_dashboard_auth_state';

  // Button text constants
  const BUTTON_TEXT = {
    SIGN_IN: "Get Data",
    REFRESH: "Refresh Data"
  };

  // Function to update sign-in button text
  function updateSignInButtonText(text) {
    const signInButton = document.querySelector('button[onclick="signIn()"]');
    if (signInButton) {
      signInButton.textContent = text;
    }
  }

  // Global sign-in function that loads data for both screens
  async function globalSignIn() {
    try {
      const signInBtn = document.getElementById('signInBtn');
      signInBtn.disabled = true;
      signInBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
      
      console.log('Starting global sign-in process from dashboard...');
      
      const loginRequest = {
        scopes: ['User.Read', 'Files.Read', 'Files.Read.All', 'Sites.Read.All']
      };
      
      const response = await msalInstance.loginPopup(loginRequest);
      console.log('Authentication successful:', response);
      
      // Get access token
      const tokenRequest = {
        scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
        account: response.account
      };
      const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
      
      // Update global auth state
      globalAuth.isAuthenticated = true;
      globalAuth.accessToken = tokenResponse.accessToken;
      globalAuth.account = response.account;
      globalAuth.userName = response.account.name || response.account.username;
      
      // Save authentication state to localStorage for cross-screen sharing
      saveAuthState();
      
      // Update UI to show signed-in state
      updateHeaderUI();
      
      // Load dashboard data
      await loadDashboardData();
      
      // Notify that global authentication is complete
      console.log('Global authentication complete. All screens can now access data.');
      
    } catch (error) {
      console.error('Global sign-in failed:', error);
      alert('Sign-in failed: ' + error.message);
      
      // Reset button state
      const signInBtn = document.getElementById('signInBtn');
      signInBtn.disabled = false;
      signInBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
    }
  }

  // Global sign-out function
  async function globalSignOut() {
    try {
      console.log('Starting global sign-out process from dashboard...');
      
      // Clear MSAL cache
      await msalInstance.logoutPopup();
      
      // Clear global auth state
      globalAuth.isAuthenticated = false;
      globalAuth.accessToken = null;
      globalAuth.account = null;
      globalAuth.userName = null;
      
      // Clear localStorage
      localStorage.removeItem(AUTH_STATE_KEY);
      
      // Update UI
      updateHeaderUI();
      
      // Reset dashboard
      clearDashboard();
      updateSignInButtonText(BUTTON_TEXT.SIGN_IN);
      
      console.log('Global sign-out complete.');
      
    } catch (error) {
      console.error('Sign-out error:', error);
      alert('Sign-out failed: ' + error.message);
    }
  }

  // Save authentication state to localStorage
  function saveAuthState() {
    const authState = {
      isAuthenticated: globalAuth.isAuthenticated,
      userName: globalAuth.userName,
      accountId: globalAuth.account?.homeAccountId,
      timestamp: Date.now()
    };
    localStorage.setItem(AUTH_STATE_KEY, JSON.stringify(authState));
  }

  // Load authentication state from localStorage
  function loadAuthState() {
    try {
      const saved = localStorage.getItem(AUTH_STATE_KEY);
      if (saved) {
        const authState = JSON.parse(saved);
        
        // Check if the saved state is not too old (24 hours)
        const isExpired = (Date.now() - authState.timestamp) > (24 * 60 * 60 * 1000);
        
        if (!isExpired && authState.isAuthenticated) {
          console.log('Found valid authentication state in localStorage');
          return authState;
        } else {
          console.log('Authentication state expired, clearing...');
          localStorage.removeItem(AUTH_STATE_KEY);
        }
      }
    } catch (error) {
      console.log('Error loading authentication state:', error);
      localStorage.removeItem(AUTH_STATE_KEY);
    }
    return null;
  }

  // Update header UI based on authentication state
  function updateHeaderUI() {
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    
    if (globalAuth.isAuthenticated) {
      signInBtn.style.display = 'none';
      signOutBtn.style.display = 'flex';
      userInfo.style.display = 'flex';
      userName.textContent = globalAuth.userName || 'User';
    } else {
      signInBtn.style.display = 'flex';
      signInBtn.disabled = false;
      signInBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
      signOutBtn.style.display = 'none';
      userInfo.style.display = 'none';
    }
  }

  // Load dashboard data using global authentication
  async function loadDashboardData() {
    try {
      if (!globalAuth.isAuthenticated || !globalAuth.accessToken) {
        throw new Error('Not authenticated');
      }
      
      updateSignInButtonText('Loading Data...');
      
      // Use existing dashboard data loading logic with global auth
      await loadDataWithGlobalAuth();
      
      updateSignInButtonText(BUTTON_TEXT.REFRESH);
      
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      alert('Failed to load dashboard data: ' + error.message);
      updateSignInButtonText(BUTTON_TEXT.SIGN_IN);
    }
  }

  // Clear dashboard data
  function clearDashboard() {
    // Reset all dashboard elements to initial state
    document.getElementById('totalSalesYear').textContent = '$0';
    document.getElementById('salesVsLastYear').textContent = '▲ $0 vs last FY';
    document.getElementById('totalSalesMonth').textContent = '$0';
    document.getElementById('salesVsLastMonth').textContent = '▼ $0 vs last month';
    document.getElementById('cashFlowTotalPeriod').textContent = '$0';
    document.getElementById('outstandingTotal').textContent = '$0';
    document.getElementById('avgAgeing').textContent = 'Avg Age: 0 days';
    
    // Clear tables
    document.getElementById('salesByCustomerTable').innerHTML = '';
    document.getElementById('cashFlowCustomerTable').innerHTML = '';
    
    // Clear filters
    document.getElementById('year').innerHTML = '<option value="">All Years</option>';
  }

  //Using Microsoft Graph API to read Excel files from OneDrive requires authentication
    // Use centralized configuration
    const msalConfig = window.FinanceDashboardConfig.msalConfig;
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function signIn() {
      try {
        if (!globalAuth.isAuthenticated) {
          // If not authenticated globally, redirect to global sign-in
          await globalSignIn();
          return;
        } else {
          // Refresh data - user already authenticated globally
          updateSignInButtonText('Refreshing Data...');
          
          // Ensure we have a fresh token
          const tokenRequest = {
            scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
            account: globalAuth.account
          };
          
          const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
          globalAuth.accessToken = tokenResponse.accessToken;
          
          // Call the function to load data from OneDrive
          await loadDataFromOneDrive(globalAuth.accessToken);
          
          // Update button text to show refresh option
          updateSignInButtonText(BUTTON_TEXT.REFRESH);
        }
        
      } catch (error) {
        console.error("Error in signIn:", error);
        alert("Error: " + error.message);
        updateSignInButtonText(BUTTON_TEXT.SIGN_IN);
        
        // If token is invalid, clear global auth
        if (error.message.includes('token') || error.message.includes('auth')) {
          globalAuth.isAuthenticated = false;
          updateHeaderUI();
          localStorage.removeItem(AUTH_STATE_KEY);
        }
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    // New function to load data using global authentication
    async function loadDataWithGlobalAuth() {
      try {
        if (!globalAuth.isAuthenticated || !globalAuth.accessToken) {
          throw new Error('Global authentication required');
        }
        
        // Call the existing function to load data from OneDrive
        await loadDataFromOneDrive(globalAuth.accessToken);
        
      } catch (error) {
        console.error("Error loading data with global auth:", error);
        throw error;
      }
    }

    async function loadDataFromOneDrive(accessToken) {
      try {
        // Use centralized configuration
        const config = window.FinanceDashboardConfig;
        const FILEOWNER_EMAIL = config.getOwnerEmail();
        const FILE_NAME = config.getPrimaryFileName();
        const ALTERNATIVE_FILE_NAMES = config.getFileSearchNames();
        
        console.log(`Searching for file: ${FILE_NAME}`);
        
        // First, let's determine the best approach based on user context
        let currentUserEmail = null;
        try {
          const userInfoResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            currentUserEmail = userInfo.mail || userInfo.userPrincipalName;
          }
        } catch (error) {
          console.log("Could not get current user info:", error.message);
        }
        
        // Determine if current user is the file owner
        const isFileOwner = currentUserEmail && currentUserEmail.toLowerCase() === FILEOWNER_EMAIL.toLowerCase();
        
        if (isFileOwner) {
          
          // Method 3: Search in current user's drive (for file owner)
          try {
            const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${FILE_NAME}')`;
            const searchResponse = await fetch(searchUrl, {
              headers: { Authorization: `Bearer ${accessToken}` }
            });
            
            if (searchResponse.ok) {
              const searchResults = await searchResponse.json();
              const file = searchResults.value?.find(item => 
                item.name === FILE_NAME && item.file
              );
              
              if (file) {
                const fileUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`;
                const fileResponse = await fetch(fileUrl, {
                  headers: { Authorization: `Bearer ${accessToken}` }
                });
                
                if (fileResponse.ok) {
                  const arrayBuffer = await fileResponse.arrayBuffer();
                  await processFileData(arrayBuffer);
                  return;
                }
              }
            }
          } catch (error) {
            console.log("File owner's drive search failed:", error.message);
          }
        } else {
          // Method 2: Search in shared items - for users who received the file
          try {
            const sharedItemsUrl = `https://graph.microsoft.com/v1.0/me/drive/sharedWithMe`;
            
            const sharedResponse = await fetch(sharedItemsUrl, {
              headers: { Authorization: `Bearer ${accessToken}` }
            });
            
            if (sharedResponse.ok) {
              const sharedData = await sharedResponse.json();
              console.log("Shared items found:", sharedData.value?.length || 0);
              
              // Log first few shared file names for debugging
              if (sharedData.value && sharedData.value.length > 0) {
                console.log("First 10 shared files:", sharedData.value.slice(0, 10).map(item => item.name));
              }
              
              // Try to find file with any of the alternative names
              let targetFile = null;
              let matchedFileName = null;
              
              for (const fileName of ALTERNATIVE_FILE_NAMES) {
                console.log(`Looking for: ${fileName}`);
                targetFile = sharedData.value?.find(item => 
                  item.name === fileName && item.file
                );
                if (targetFile) {
                  matchedFileName = fileName;
                  console.log(`Found file: ${fileName}`);
                  break;
                }
              }
              
              // If exact match fails, try case-insensitive search
              if (!targetFile) {
                console.log("Exact match failed, trying case-insensitive search...");
                for (const fileName of ALTERNATIVE_FILE_NAMES) {
                  targetFile = sharedData.value?.find(item => 
                    item.name?.toLowerCase() === fileName.toLowerCase() && item.file
                  );
                  if (targetFile) {
                    matchedFileName = fileName;
                    console.log(`Found file (case-insensitive): ${targetFile.name}`);
                    break;
                  }
                }
              }
              
              if (targetFile) {
                const fileContentUrl = `https://graph.microsoft.com/v1.0/drives/${targetFile.remoteItem.parentReference.driveId}/items/${targetFile.remoteItem.id}/content`;
                
                const fileResponse = await fetch(fileContentUrl, {
                  headers: { Authorization: `Bearer ${accessToken}` }
                });
                
                if (fileResponse.ok) {
                  const arrayBuffer = await fileResponse.arrayBuffer();
                  await processFileData(arrayBuffer);
                  return;
                } else {
                  console.error("Failed to fetch file content:", fileResponse.status, fileResponse.statusText);
                }
              }
            } else {
              console.error("Failed to fetch shared items:", sharedResponse.status, sharedResponse.statusText);
            }
          } catch (error) {
            console.error("Shared items method failed:", error);
          }
          
          // Fallback: Try searching in current user's drive (maybe they have a copy)
          try {
            const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${FILE_NAME}')`;
            const searchResponse = await fetch(searchUrl, {
              headers: { Authorization: `Bearer ${accessToken}` }
            });
            
            if (searchResponse.ok) {
              const searchResults = await searchResponse.json();
              const file = searchResults.value?.find(item => 
                item.name === FILE_NAME && item.file
              );
              
              if (file) {
                const fileUrl = `https://graph.Microsoft.com/v1.0/me/drive/items/${file.id}/content`;
                const fileResponse = await fetch(fileUrl, {
                  headers: { Authorization: `Bearer ${accessToken}` }
                });
                
                if (fileResponse.ok) {
                  const arrayBuffer = await fileResponse.arrayBuffer();
                  await processFileData(arrayBuffer);
                  return;
                }
              }
            }
          } catch (error) {
            console.log("Current user drive search failed:", error.message);
          }
        }
        
        // If all methods fail
        console.log(`File search failed. Searched for: ${ALTERNATIVE_FILE_NAMES.join(', ')}`);
        throw new Error(`File '${FILE_NAME}' not found. Please ensure:\n1. File exists in ${FILEOWNER_EMAIL}'s OneDrive\n2. File is shared with your account\n3. You have appropriate permissions\n4. File name is correct\n\nSearched for: ${ALTERNATIVE_FILE_NAMES.join(', ')}\n\nCheck browser console for detailed logs.`);
        
      } catch (error) {
        console.error("Error loading data:", error);
        alert(`Error loading data: ${error.message}`);
      }
    }
    
    // Helper function to process file data
    async function processFileData(arrayBuffer) {
      try {
        // Use SheetJS to parse Excel - read from specific EXPORT_SALES sheet
        const workbook = XLSX.read(arrayBuffer, { type: "array", cellDates: false });
        
        // Use centralized configuration for sheet name
        const config = window.FinanceDashboardConfig;
        let targetSheetName = config.getSheetName('dashboard');
        
        if (!workbook.SheetNames.includes(targetSheetName)) {
          // Try alternative sheet names if exact match not found
          const alternativeNames = ['Export_Sales', 'export_sales', 'Export Sales', 'EXPORT SALES'];
          targetSheetName = alternativeNames.find(name => workbook.SheetNames.includes(name));
          
          if (!targetSheetName) {
            targetSheetName = workbook.SheetNames[0];
          }
        }
        
        const worksheet = workbook.Sheets[targetSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' });

        // Process the data using the same logic as handleFileUpload
        processExcelData(jsonData);
        
      } catch (error) {
        console.error("Error processing file data:", error);
        throw error;
      }
    }

    //End Microsoft Graph API authentication code

    // Function to check if user is already signed in and load data automatically
    async function initializeApp() {
        try {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                // User is already signed in, try to get token silently
                try {
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ["Files.Read", "Sites.Read.All"],
                        account: accounts[0]
                    });
                    
                    // Load data automatically
                    await loadDataFromOneDrive(tokenResponse.accessToken);
                    
                    // Update sign-in button text
                    updateSignInButtonText(BUTTON_TEXT.REFRESH);
                    
                } catch (error) {
                    // Silent token acquisition failed, user needs to sign in again
                }
            }
        } catch (error) {
            console.error("Error during app initialization:", error);
        }
    }

    let allFinancialData = [];
    let financialYears = new Set();
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    let invoiceChart, activeClientsChart, subsidiariesChart;
    let currentPeriodFilteredData = [];
    let currentMetrics = {};

    let activeClientsPopupElement, activeClientsPopupSummaryElement;
    let fySalesClientPopupElement, monthSalesClientPopupElement, periodOutstandingPopupElement, chargesDetailsPopupElement, invoiceChartDetailsPopupElement;
    let periodOutstandingPopupTitleElement, periodOutstandingPopupSummaryElement, periodOutstandingTableContainerElement;

    const EXPECTED_COLUMNS = {
      DATE: 'Invoice Date', INVOICE_NO: 'Invoice No', INVOICE_VALUE: 'Invoice Value',
      RECEIVED_VALUE: 'Rcvd Value', CHARGES: 'Charges', CUSTOMER: 'Client Name',
      STATUS: 'Status', SOFTEX: 'Softex No', BRC: 'BRC No', DUE_DATE: 'Due Date',
      SUBSIDIARY: 'Subsidiary', RECEIVED_DATE: 'Received Date',
      DUE_IN_USD: 'Due in $',
      DUE_PERIOD: 'Due'
    };

    function getFinancialYear(date) { if (!(date instanceof Date) || isNaN(date)) return null; const year = date.getFullYear(); const month = date.getMonth(); return month < 3 ? year - 1 : year; }
    function initializeCharts() { const chartTextColor='#9CA3AF';const chartGridColor='#4B5563';const invoiceCtx=document.getElementById('invoiceChart')?.getContext('2d');const activeCtx=document.getElementById('activeClientsChart')?.getContext('2d');const subsCtx=document.getElementById('subsidiariesChart')?.getContext('2d');if(invoiceChart)invoiceChart.destroy();if(activeClientsChart)activeClientsChart.destroy();if(subsidiariesChart)subsidiariesChart.destroy();const commonChartOptions={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:chartTextColor},grid:{color:chartGridColor,borderColor:chartGridColor}},x:{ticks:{color:chartTextColor},grid:{color:chartGridColor,borderColor:chartGridColor}}}};if(invoiceCtx){invoiceChart=new Chart(invoiceCtx,{type:'bar',data:{labels:['Invoices','Softex','BRC'],datasets:[{label:'Count',data:[0,0,0],backgroundColor:['#4FD1C5','#63B3ED','#F6E05E']}]},options:{...commonChartOptions,onClick:(event,elements)=>{if(elements.length>0){const clickedIndex=elements[0].index;const label=invoiceChart.data.labels[clickedIndex];handleInvoiceChartBarClick(label);}}}});} if(activeCtx){let activeChartOptions=JSON.parse(JSON.stringify(commonChartOptions));activeChartOptions.indexAxis='y';activeChartOptions.scales.x.ticks.stepSize=1;activeClientsChart=new Chart(activeCtx,{type:'bar',data:{labels:['Total Clients (Historical)','Active Clients (Period)'],datasets:[{label:'Client Count',data:[0,0],backgroundColor:['#63B3ED','#4FD1C5'],borderColor:['#63B3ED','#4FD1C5'],borderWidth:1}]},options:activeChartOptions});} if(subsCtx){subsidiariesChart=new Chart(subsCtx,{type:'doughnut',data:{labels:[],datasets:[{label:'Subsidiary Sales',data:[],backgroundColor:['#4FD1C5', '#63B3ED', '#F6E05E', '#F56565', '#B794F4', '#ED8936'],borderColor:'#263138',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:chartTextColor}}}}});}}
    function formatCurrency(value, digits = 0) { 
        // Handle null, undefined, or empty values
        if (value == null || value === '') return '$0';
        
        const num = Number(value); 
        if (isNaN(num)) {
            // Try to clean the value first if it's a string
            if (typeof value === 'string') {
                const cleaned = value.replace(/[$,\s\u00A0]/g, '');
                const cleanedNum = parseFloat(cleaned);
                if (!isNaN(cleanedNum)) {
                    return formatCurrency(cleanedNum, digits);
                }
            }
            return '$0'; // Return $0 instead of throwing error
        }
        
        const absValue = Math.abs(num); 
        if (absValue >= 1000000) { 
            return (num < 0 ? '-' : '') + '$' + (absValue / 1000000).toFixed(1) + 'M'; 
        } else if (absValue >= 1000) { 
            return (num < 0 ? '-' : '') + '$' + (absValue / 1000).toFixed(0) + 'K'; 
        } 
        return new Intl.NumberFormat('en-US', { 
            style: 'currency', 
            currency: 'USD', 
            minimumFractionDigits: digits, 
            maximumFractionDigits: digits 
        }).format(num);
    }
    function formatPercentage(current, previous) { if (previous === 0 || previous == null || isNaN(previous)) { return current > 0 ? "+100%" : (current < 0 ? "-100%" : "0%"); } if (current == null || isNaN(current)) current = 0; const percentageChange = ((current - previous) / previous) * 100; const sign = percentageChange > 0 ? '+' : (percentageChange < 0 ? '' : ''); return `${sign}${percentageChange.toFixed(1)}%`; }
    function cleanCurrency(value) { if (typeof value === 'number') return value; if (value === null || value === undefined) return 0; let stringValue = String(value).trim(); if (stringValue === '' || stringValue === '-') return 0; const cleaned = stringValue.replace(/[$,\s\u00A0]/g, ''); const num = parseFloat(cleaned); if (isNaN(num)) { return 0; } return num;    }
    
    // Simplified updateTable function, no longer handles special cases
    function updateTable(tableBodyId, dataRows, columnConfigs = [], noDataMessage = 'No data available for this selection.') {
        const tbody = document.getElementById(tableBodyId);
        if (!tbody) { 
            console.warn(`Table body with ID '${tableBodyId}' not found.`); 
            return; 
        }
        tbody.innerHTML = '';
        if (dataRows && dataRows.length > 0) {
            dataRows.forEach(rowData => {
                const tr = document.createElement('tr');
                const cells = Array.isArray(rowData) ? rowData : Object.values(rowData);
                cells.forEach((cellData, index) => {
                    const td = document.createElement('td');
                    let formattedData = cellData != null ? String(cellData) : '';
                    const config = columnConfigs[index] || {};
                    if (config.formatter) {
                        try { 
                            formattedData = config.formatter(cellData, rowData); 
                        }
                        catch (formatError) { 
                            // Instead of showing "Error", try to display the raw value or a fallback
                            if (cellData != null && cellData !== '') {
                                formattedData = String(cellData); // Show raw value
                            } else {
                                formattedData = '$0'; // Show $0 for currency fields
                            }
                        }
                    }
                    if (config.className) { td.className = config.className; }
                    td.textContent = formattedData;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        } else {
            const colCount = tbody.previousElementSibling?.querySelector('tr')?.children?.length || 1;
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', colCount);
            td.textContent = noDataMessage;
            td.style.textAlign = 'center';
            td.style.color = '#AAAAAA';
            tr.appendChild(td);
        }
    }

    function formatDate(date) { if (!date || !(date instanceof Date) || isNaN(date)) return 'N/A'; return `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;    }
    function formatNullableString(value) { return value == null || String(value).trim() === '' || String(value).trim().toLowerCase() === 'n/a' ? 'N/A' : String(value);    }
    function parseDateValue(dateValue) { if (!dateValue) return null; let jsDate; if (typeof dateValue === 'number') { jsDate = XLSX.SSF.parse_date_code(dateValue); return new Date(jsDate.y, jsDate.m - 1, jsDate.d, jsDate.H || 0, jsDate.M || 0, jsDate.S || 0); } else if (dateValue instanceof Date) { jsDate = dateValue; } else if (typeof dateValue === 'string') { const parsed = new Date(dateValue); if (!isNaN(parsed.getTime())) { jsDate = parsed; } else { const parts = dateValue.match(/(\d{1,2})\s*(\w+)\s*(\d{4})/); if (parts && parts.length === 4) { try { jsDate = new Date(`${parts[2]} ${parts[1]}, ${parts[3]}`); } catch (e) { jsDate = null; } } else { const excelDateParts = dateValue.split(/[\/-]/); if (excelDateParts.length === 3) { let day, month, year; if (excelDateParts[0].length === 4) { year = parseInt(excelDateParts[0]); month = parseInt(excelDateParts[1]) -1; day = parseInt(excelDateParts[2]); } else if (excelDateParts[2].length === 4) { year = parseInt(excelDateParts[2]); month = parseInt(excelDateParts[0]) -1; day = parseInt(excelDateParts[1]); } if (!isNaN(day) && !isNaN(month) && !isNaN(year)) { jsDate = new Date(year, month, day); } } else { jsDate = null; } } } } else { jsDate = null; } if (jsDate && !isNaN(jsDate.getTime())) { return jsDate; } return null;     }
    
    // Extract data processing logic to be reused by both file upload and Microsoft Graph API
    function processExcelData(jsonData) {
        
        // Log all available column names from first row for debugging
        if (jsonData.length > 0) {
            const firstRowKeys = Object.keys(jsonData[0]).map(key => key.trim());
            
            // Check which expected columns are missing
            const missingColumns = [];
            const foundColumns = [];
            for (const [key, expectedCol] of Object.entries(EXPECTED_COLUMNS)) {
                if (!firstRowKeys.includes(expectedCol)) {
                    missingColumns.push(`${key}: '${expectedCol}'`);
                } else {
                    foundColumns.push(`${key}: '${expectedCol}'`);
                }
            }
            
            if (missingColumns.length > 0) {
                console.warn("Missing columns:", missingColumns);
            }
        }
        
        financialYears.clear();
        const cleanedData = [];
        
        jsonData.forEach((rawRow, index) => {
            const rowWithTrimmedKeys = {};
            for (const key in rawRow) {
                if (Object.hasOwnProperty.call(rawRow, key)) {
                    const trimmedKey = key.trim();
                    rowWithTrimmedKeys[trimmedKey] = rawRow[key];
                }
            }
            
            // Log first few rows for debugging
            if (index < 3) {
                // Debug logging for first few rows
            }
            
            const cleanedRow = {};
            cleanedRow.jsDate = parseDateValue(rowWithTrimmedKeys[EXPECTED_COLUMNS.DATE]);
            if (!cleanedRow.jsDate) {
                return;
            }
            
            const fy = getFinancialYear(cleanedRow.jsDate);
            if (fy !== null) {
                cleanedRow.fy = fy;
                financialYears.add(fy);
            } else {
                return;
            }
            
            cleanedRow.jsDueDate = parseDateValue(rowWithTrimmedKeys[EXPECTED_COLUMNS.DUE_DATE]);
            cleanedRow.jsReceivedDate = parseDateValue(rowWithTrimmedKeys[EXPECTED_COLUMNS.RECEIVED_DATE]);
            cleanedRow[EXPECTED_COLUMNS.INVOICE_NO] = String(rowWithTrimmedKeys[EXPECTED_COLUMNS.INVOICE_NO] || 'N/A').trim();
            cleanedRow[EXPECTED_COLUMNS.INVOICE_VALUE] = cleanCurrency(rowWithTrimmedKeys[EXPECTED_COLUMNS.INVOICE_VALUE]);
            cleanedRow[EXPECTED_COLUMNS.RECEIVED_VALUE] = cleanCurrency(rowWithTrimmedKeys[EXPECTED_COLUMNS.RECEIVED_VALUE]);
            cleanedRow[EXPECTED_COLUMNS.CHARGES] = cleanCurrency(rowWithTrimmedKeys[EXPECTED_COLUMNS.CHARGES]);
            cleanedRow[EXPECTED_COLUMNS.DUE_IN_USD] = cleanCurrency(rowWithTrimmedKeys[EXPECTED_COLUMNS.DUE_IN_USD]);
            cleanedRow[EXPECTED_COLUMNS.DUE_PERIOD] = cleanCurrency(rowWithTrimmedKeys[EXPECTED_COLUMNS.DUE_PERIOD]);
            cleanedRow[EXPECTED_COLUMNS.CUSTOMER] = String(rowWithTrimmedKeys[EXPECTED_COLUMNS.CUSTOMER] || '').trim();
            cleanedRow[EXPECTED_COLUMNS.STATUS] = String(rowWithTrimmedKeys[EXPECTED_COLUMNS.STATUS] || '').trim();
            cleanedRow[EXPECTED_COLUMNS.SUBSIDIARY] = String(rowWithTrimmedKeys[EXPECTED_COLUMNS.SUBSIDIARY] || '').trim();
            
            const softexValRaw = String(rowWithTrimmedKeys[EXPECTED_COLUMNS.SOFTEX] || '').trim();
            cleanedRow[EXPECTED_COLUMNS.SOFTEX + '_VALUE'] = softexValRaw;
            cleanedRow[EXPECTED_COLUMNS.SOFTEX] = (softexValRaw !== '' && softexValRaw !== '0') ? 1 : 0;
            
            const brcValRaw = String(rowWithTrimmedKeys[EXPECTED_COLUMNS.BRC] || '').trim();
            cleanedRow[EXPECTED_COLUMNS.BRC + '_VALUE'] = brcValRaw;
            cleanedRow[EXPECTED_COLUMNS.BRC] = (brcValRaw !== '' && brcValRaw !== '0') ? 1 : 0;
            
            cleanedData.push(cleanedRow);
        });
        
        allFinancialData = cleanedData;
        
        if(allFinancialData.length === 0){
            alert("No valid data rows were found or parsed. Please check the Excel file format and column headers.");
        }
        
        populateFyDropdown();
        refreshDashboard();
    }

    function handleFileUpload(event) { 
        const file = event.target.files[0]; 
        if (!file) return; 
        
        document.body.style.cursor = 'wait'; 
        const reader = new FileReader(); 
        
        reader.onload = (e) => { 
            try { 
                const data = new Uint8Array(e.target.result); 
                const workbook = XLSX.read(data, { type: 'array', cellDates: false }); 
                
                // Look for EXPORT_SALES sheet specifically
                let targetSheetName = 'EXPORT_SALES';
                if (!workbook.SheetNames.includes(targetSheetName)) {
                  // Try alternative sheet names if exact match not found
                  const alternativeNames = ['Export_Sales', 'export_sales', 'Export Sales', 'EXPORT SALES'];
                  targetSheetName = alternativeNames.find(name => workbook.SheetNames.includes(name));
                  
                  if (!targetSheetName) {
                    targetSheetName = workbook.SheetNames[0];
                  }
                }
                
                const worksheet = workbook.Sheets[targetSheetName]; 
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' }); 
                
                // Use the extracted processing function
                processExcelData(jsonData);
                
            } catch (error) { 
                console.error("Error processing Excel file:", error); 
                alert("Error processing Excel file. Check console for details."); 
                allFinancialData = []; 
                populateFyDropdown(); 
                refreshDashboard(); 
            } finally { 
                document.body.style.cursor = 'default'; 
                event.target.value = null; 
            } 
        }; 
        
        reader.onerror = (error) => { 
            console.error("Error reading file:", error); 
            alert("Error reading file. Check console for details."); 
            document.body.style.cursor = 'default'; 
            event.target.value = null; 
        }; 
        
        reader.readAsArrayBuffer(file);    
    }
    function populateFyDropdown() { const yearSelect = document.getElementById('year'); yearSelect.innerHTML = '<option value="">All Years</option>'; const sortedFy = Array.from(financialYears).sort((a, b) => a - b); sortedFy.forEach(fyStartYear => { const option = document.createElement('option'); option.value = fyStartYear; option.textContent = `FY ${fyStartYear}-${String(fyStartYear + 1).slice(-2)}`; yearSelect.appendChild(option); }); document.getElementById('month').value = ""; }
    function filterData() { const selectedFyStartYear = document.getElementById('year').value; const selectedMonth = document.getElementById('month').value; if (!selectedFyStartYear) { if (selectedMonth !== "") { return allFinancialData.filter(row => row.jsDate.getMonth() == parseInt(selectedMonth)); } else { return allFinancialData; } } const fyStart = parseInt(selectedFyStartYear); const fyStartDate = new Date(fyStart, 3, 1); const fyEndDate = new Date(fyStart + 1, 3, 0); fyStartDate.setHours(0, 0, 0, 0); fyEndDate.setHours(23, 59, 59, 999); let filtered = allFinancialData.filter(row => row.jsDate >= fyStartDate && row.jsDate <= fyEndDate); if (selectedMonth !== "") { const monthIndex = parseInt(selectedMonth); const calendarYear = monthIndex >= 3 ? fyStart : fyStart + 1; filtered = filtered.filter(row => row.jsDate.getFullYear() === calendarYear && row.jsDate.getMonth() === monthIndex); } return filtered;     }
    function getPreviousPeriodData(fyStartYearStr, monthStr) { const currentFyStart = fyStartYearStr ? parseInt(fyStartYearStr) : null; const currentMonthIndex = (monthStr !== "" && monthStr !== null && monthStr !== undefined) ? parseInt(monthStr) : null; let prevStartDate, prevEndDate; if (currentMonthIndex !== null && currentFyStart !== null) { let prevMonthCalendarYear = currentMonthIndex >= 3 ? currentFyStart : currentFyStart + 1; let prevMonthIndex = currentMonthIndex - 1; if (prevMonthIndex < 0) { prevMonthIndex = 11; prevMonthCalendarYear--; } return allFinancialData.filter(row => row.jsDate.getFullYear() === prevMonthCalendarYear && row.jsDate.getMonth() === prevMonthIndex); } else if (currentFyStart !== null) { const prevFyStart = currentFyStart - 1; prevStartDate = new Date(prevFyStart, 3, 1); prevEndDate = new Date(prevFyStart + 1, 3, 0); prevStartDate.setHours(0, 0, 0, 0); prevEndDate.setHours(23, 59, 59, 999); return allFinancialData.filter(row => row.jsDate >= prevStartDate && row.jsDate <= prevEndDate); } else { if (financialYears.size === 0) return []; const latestFyStart = Math.max(...Array.from(financialYears)); const prevFyStart = latestFyStart - 1; prevStartDate = new Date(prevFyStart, 3, 1); prevEndDate = new Date(prevFyStart + 1, 3, 0); prevStartDate.setHours(0, 0, 0, 0); prevEndDate.setHours(23, 59, 59, 999); return allFinancialData.filter(row => row.jsDate >= prevStartDate && row.jsDate <= prevEndDate); }     }
    function calculateFySalesByClient(fyStartYear) { if (fyStartYear === null || fyStartYear === undefined || isNaN(parseInt(fyStartYear))) return []; const targetFy = parseInt(fyStartYear); const salesMap = new Map(); allFinancialData.forEach(row => { if (row.fy === targetFy) { const customer = row[EXPECTED_COLUMNS.CUSTOMER]; const invoiceValue = row[EXPECTED_COLUMNS.INVOICE_VALUE]; if (customer && typeof invoiceValue === 'number' && !isNaN(invoiceValue)) { salesMap.set(customer, (salesMap.get(customer) || 0) + invoiceValue); } } }); return Array.from(salesMap.entries()).map(([customer, sales]) => ({ customer, sales })).sort((a, b) => b.sales - a.sales);    }

    function calculateMetrics(data, allData) {
          const metrics = {
            totalSalesYear: 0, salesVsLastYearAmount: 0, totalSalesMonth: 0, salesVsLastMonthAmount: 0,
            totalSalesPeriod: 0, totalReceivedPeriod: 0, salesByCustomerPeriod: [], cashFlowByCustomerPeriod: [],
            outstandingTotalPeriod: 0, avgAgeing: 0, invoiceCount: 0, softexCount: 0, brcCount: 0,
            activeClientsPeriodCount: 0, totalClientsHistoricalCount: 0, topRevenuePeriod: [],
            totalChargesPeriod: 0, subsidiarySales: [],
            outstandingByClientFromDueColumn: [],
            previousFyTotalSales: 0, previousMonthTotalSales: 0,
            activeClientList: [],
          };
          const selectedFyStartYear = document.getElementById('year').value; const selectedMonth = document.getElementById('month').value;
          const salesByCustomerMap = new Map(); const cashFlowByCustomerMap = new Map();
          const customersInPeriod = new Set();
          let totalAgeingDaysSum = 0; let totalDueAmountForAgeing = 0;
          const subsidiarySalesMap = new Map();
          const today = new Date(); today.setHours(0, 0, 0, 0);

          data.forEach((row) => {
              const invoiceValue = row[EXPECTED_COLUMNS.INVOICE_VALUE]; const receivedValue = row[EXPECTED_COLUMNS.RECEIVED_VALUE];
              const chargesValue = row[EXPECTED_COLUMNS.CHARGES]; const customer = row[EXPECTED_COLUMNS.CUSTOMER];
              const subsidiary = row[EXPECTED_COLUMNS.SUBSIDIARY]; const dueDate = row.jsDueDate;
              const dueForPeriod = row[EXPECTED_COLUMNS.DUE_PERIOD];

              if (typeof invoiceValue === 'number' && !isNaN(invoiceValue)) { metrics.totalSalesPeriod += invoiceValue; if (customer) { salesByCustomerMap.set(customer, (salesByCustomerMap.get(customer) || 0) + invoiceValue); customersInPeriod.add(customer); } }
              if (typeof receivedValue === 'number' && !isNaN(receivedValue)) { metrics.totalReceivedPeriod += receivedValue; if (customer) cashFlowByCustomerMap.set(customer, (cashFlowByCustomerMap.get(customer) || 0) + receivedValue); }
              if (typeof chargesValue === 'number' && !isNaN(chargesValue)) { metrics.totalChargesPeriod += chargesValue; }
              if (typeof dueForPeriod === 'number' && !isNaN(dueForPeriod)) { metrics.outstandingTotalPeriod += dueForPeriod; }

              if (typeof dueForPeriod === 'number' && dueForPeriod > 0.01 && dueDate) {
                   const referenceDate = new Date(dueDate); referenceDate.setHours(0, 0, 0, 0);
                   if (today > referenceDate) {
                       const diffTime = today.getTime() - referenceDate.getTime();
                       const diffDays = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                       totalAgeingDaysSum += (dueForPeriod * diffDays); totalDueAmountForAgeing += dueForPeriod;
                   }
              }
               if (row[EXPECTED_COLUMNS.SOFTEX] === 1) metrics.softexCount++;
               if (row[EXPECTED_COLUMNS.BRC] === 1) metrics.brcCount++;
               metrics.invoiceCount++;
              if (subsidiary && subsidiary !== '' && typeof invoiceValue === 'number' && !isNaN(invoiceValue)) { subsidiarySalesMap.set(subsidiary, (subsidiarySalesMap.get(subsidiary) || 0) + invoiceValue); }
          });

          metrics.salesByCustomerPeriod = Array.from(salesByCustomerMap.entries()).sort((a, b) => b[1] - a[1]);
          metrics.cashFlowByCustomerPeriod = Array.from(cashFlowByCustomerMap.entries()).sort((a, b) => b[1] - a[1]);
          metrics.avgAgeing = totalDueAmountForAgeing > 0 ? Math.round(totalAgeingDaysSum / totalDueAmountForAgeing) : 0;
          metrics.activeClientsPeriodCount = customersInPeriod.size;
          metrics.activeClientList = Array.from(customersInPeriod).sort();
          metrics.subsidiarySales = Array.from(subsidiarySalesMap.entries()).sort((a, b) => b[1] - a[1]);
          const totalRevenuePeriod = metrics.totalSalesPeriod;
          metrics.topRevenuePeriod = metrics.salesByCustomerPeriod.slice(0, 5).map(([customer, revenue]) => ({ customer: customer, revenue: revenue, contribution: totalRevenuePeriod > 0 ? (revenue / totalRevenuePeriod) * 100 : 0 }));

          const outstandingByClientFromDueMap_Period = new Map();
          data.forEach(row => {
              const customer = row[EXPECTED_COLUMNS.CUSTOMER];
              if (customer) {
                  const dueValueFromPeriodColumn = row[EXPECTED_COLUMNS.DUE_PERIOD];
                  if (typeof dueValueFromPeriodColumn === 'number' && !isNaN(dueValueFromPeriodColumn) && dueValueFromPeriodColumn > 0.001) {
                      outstandingByClientFromDueMap_Period.set(customer, (outstandingByClientFromDueMap_Period.get(customer) || 0) + dueValueFromPeriodColumn);
                  }
              }
          });
          metrics.outstandingByClientFromDueColumn = Array.from(outstandingByClientFromDueMap_Period.entries()).filter(entry => entry[1] > 0.01).sort((a, b) => b[1] - a[1]);
          
          if (selectedMonth !== "") { metrics.totalSalesMonth = metrics.totalSalesPeriod; const prevMonthData = getPreviousPeriodData(selectedFyStartYear, selectedMonth); metrics.previousMonthTotalSales = prevMonthData.reduce((sum, row) => sum + (Number(row[EXPECTED_COLUMNS.INVOICE_VALUE]) || 0), 0); metrics.salesVsLastMonthAmount = metrics.totalSalesMonth - metrics.previousMonthTotalSales; }
          if (selectedFyStartYear !== "") { const fyStart = parseInt(selectedFyStartYear); const fyStartDate = new Date(fyStart, 3, 1); const fyEndDate = new Date(fyStart + 1, 3, 0); fyStartDate.setHours(0,0,0,0); fyEndDate.setHours(23,59,59,999); const currentFyData = allData.filter(row => row.jsDate >= fyStartDate && row.jsDate <= fyEndDate); metrics.totalSalesYear = currentFyData.reduce((sum, row) => sum + (Number(row[EXPECTED_COLUMNS.INVOICE_VALUE]) || 0), 0); const prevFyData = getPreviousPeriodData(selectedFyStartYear, ""); metrics.previousFyTotalSales = prevFyData.reduce((sum, row) => sum + (Number(row[EXPECTED_COLUMNS.INVOICE_VALUE]) || 0), 0); metrics.salesVsLastYearAmount = metrics.totalSalesYear - metrics.previousFyTotalSales; } else { metrics.totalSalesYear = allData.reduce((sum, row) => sum + (Number(row[EXPECTED_COLUMNS.INVOICE_VALUE]) || 0), 0); const prevFyDataForAll = getPreviousPeriodData("", ""); metrics.previousFyTotalSales = prevFyDataForAll.reduce((sum, row) => sum + (Number(row[EXPECTED_COLUMNS.INVOICE_VALUE]) || 0), 0); metrics.salesVsLastYearAmount = metrics.totalSalesYear - metrics.previousFyTotalSales; }
          
          let historicalEndDate;
          if (selectedFyStartYear) { const fyEndYear = parseInt(selectedFyStartYear) + 1; historicalEndDate = new Date(fyEndYear, 3, 0); }
          else { historicalEndDate = allData.length > 0 ? allData.reduce((max, row) => row.jsDate > max ? row.jsDate : max, allData[0].jsDate) : new Date(); }
          historicalEndDate.setHours(23, 59, 59, 999);
          const historicalCustomers = new Set();
          allData.forEach(row => { if (row.jsDate <= historicalEndDate) { const customer = row[EXPECTED_COLUMNS.CUSTOMER]; if (customer) { historicalCustomers.add(customer); } } });
          metrics.totalClientsHistoricalCount = historicalCustomers.size;

          return metrics;
     }

    function showPopup(popupElement) { if (popupElement) popupElement.style.display = 'flex'; }
    function hidePopup(popupElement) { if (popupElement) popupElement.style.display = 'none'; }
    
    function showFySalesDetailsPopup() { const selectedFyValue = document.getElementById('year').value; if (!selectedFyValue) { alert("Please select a specific Financial Year from the filter."); return; } const fyStart = parseInt(selectedFyValue); const clientSalesData = calculateFySalesByClient(fyStart); const fySalesPopupTitleElement = document.querySelector('#fySalesClientPopup .popup-header h4'); const fySalesPopupSummaryElement = document.querySelector('#fySalesClientPopup .popup-summary'); fySalesPopupTitleElement.textContent = `Client Sales for FY ${fyStart}-${String(fyStart + 1).slice(-2)}`; const currentFyTotal = currentMetrics.totalSalesYear; const prevFyTotal = currentMetrics.previousFyTotalSales; const diff = currentFyTotal - prevFyTotal; const percentChange = formatPercentage(currentFyTotal, prevFyTotal); const comparisonText = `Total Sales: ${formatCurrency(currentFyTotal)}. Compared to Previous FY (${formatCurrency(prevFyTotal)}): ${diff >= 0 ? '▲' : '▼'} ${formatCurrency(Math.abs(diff))} (${percentChange})`; fySalesPopupSummaryElement.innerHTML = comparisonText; fySalesPopupSummaryElement.className = `popup-summary ${diff >= 0 ? 'highlight' : 'down'}`; const tableData = clientSalesData.map(item => [item.customer, item.sales]); updateTable('fySalesClientTableBody', tableData, [ { }, { formatter: formatCurrency, className: 'numeric' } ]); showPopup(fySalesClientPopupElement);    }
    
    function showMonthSalesDetailsPopup() { const selectedMonthValue = document.getElementById('month').value; const selectedFyValue = document.getElementById('year').value; if (selectedMonthValue === "") { alert("Please select a specific Month from the filter."); return; } if (currentPeriodFilteredData.length === 0) { alert("No data available for the selected month."); return; } const monthIndex = parseInt(selectedMonthValue); const fyStartForTitle = selectedFyValue ? parseInt(selectedFyValue) : currentPeriodFilteredData[0].jsDate.getFullYear(); const calendarYear = monthIndex >= 3 ? fyStartForTitle : fyStartForTitle + 1; const monthSalesPopupTitleElement = document.querySelector('#monthSalesClientPopup .popup-header h4'); const monthSalesPopupSummaryElement = document.querySelector('#monthSalesClientPopup .popup-summary'); monthSalesPopupTitleElement.textContent = `Client Sales for ${monthNames[monthIndex]} ${calendarYear}`; const salesMap = new Map(); currentPeriodFilteredData.forEach(row => { const customer = row[EXPECTED_COLUMNS.CUSTOMER]; const invoiceValue = row[EXPECTED_COLUMNS.INVOICE_VALUE]; if (customer && typeof invoiceValue === 'number' && !isNaN(invoiceValue)) { salesMap.set(customer, (salesMap.get(customer) || 0) + invoiceValue); } }); const clientSalesData = Array.from(salesMap.entries()).map(([customer, sales]) => ({ customer, sales })).sort((a, b) => b.sales - a.sales); const currentMonthTotal = currentMetrics.totalSalesMonth; const prevMonthTotal = currentMetrics.previousMonthTotalSales; const diff = currentMonthTotal - prevMonthTotal; const percentChange = formatPercentage(currentMonthTotal, prevMonthTotal); const comparisonText = `Total Sales: ${formatCurrency(currentMonthTotal)}. Compared to Previous Month (${formatCurrency(prevMonthTotal)}): ${diff >= 0 ? '▲' : '▼'} ${formatCurrency(Math.abs(diff))} (${percentChange})`; monthSalesPopupSummaryElement.innerHTML = comparisonText; monthSalesPopupSummaryElement.className = `popup-summary ${diff >= 0 ? 'highlight' : 'down'}`; const tableData = clientSalesData.map(item => [item.customer, item.sales]); updateTable('monthSalesClientTableBody', tableData, [ { }, { formatter: formatCurrency, className: 'numeric' } ]); showPopup(monthSalesClientPopupElement);    }

    // BUG FIX: Rewritten function for reliability
    function showPeriodOutstandingDetailsPopup() {
        const outstandingItems = currentPeriodFilteredData
            .filter(row => (row[EXPECTED_COLUMNS.DUE_PERIOD] || 0) > 0.01)
            .map(row => ({
                customer: row[EXPECTED_COLUMNS.CUSTOMER],
                invoiceNo: row[EXPECTED_COLUMNS.INVOICE_NO],
                invDate: row.jsDate,
                dueDate: row.jsDueDate,
                invValue: row[EXPECTED_COLUMNS.INVOICE_VALUE] || 0,
                rcvdValue: row[EXPECTED_COLUMNS.RECEIVED_VALUE] || 0,
                outstanding: row[EXPECTED_COLUMNS.DUE_PERIOD] || 0,
            })).sort((a,b) => b.outstanding - a.outstanding);

        const totalOutstandingInPopup = outstandingItems.reduce((sum, item) => sum + item.outstanding, 0);
        periodOutstandingPopupSummaryElement.textContent = `Total Outstanding (from 'Due' column): ${formatCurrency(totalOutstandingInPopup)}. Average Age: ${currentMetrics.avgAgeing} days.`;
        periodOutstandingTableContainerElement.innerHTML = ''; // Clear previous content

        if (outstandingItems.length === 0) {
            periodOutstandingTableContainerElement.innerHTML = `<div class="no-data-message">No outstanding items for this period.</div>`;
        } else {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            // Create Header
            const headerRow = document.createElement('tr');
            ['Customer', 'Inv. No', 'Inv. Date', 'Due Date', "Inv. Value", "Rcvd Value", "Outstanding"].forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = headerText;
                if ([4,5,6].includes(index)) th.classList.add('numeric');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Create Body
            outstandingItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatNullableString(item.customer)}</td>
                    <td>${formatNullableString(item.invoiceNo)}</td>
                    <td>${formatDate(item.invDate)}</td>
                    <td>${formatDate(item.dueDate)}</td>
                    <td class="numeric">${formatCurrency(item.invValue, 2)}</td>
                    <td class="numeric">${formatCurrency(item.rcvdValue, 2)}</td>
                    <td class="numeric">${formatCurrency(item.outstanding, 2)}</td>
                `;
                tbody.appendChild(tr);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            periodOutstandingTableContainerElement.appendChild(table);
        }
        showPopup(periodOutstandingPopupElement);
    }

    function showChargesDetailsPopup() { const chargesDetailsPopupTitleElement = document.querySelector('#chargesDetailsPopup .popup-header h4'); const chargesDetailsPopupSummaryElement = document.querySelector('#chargesDetailsPopup .popup-summary'); if (currentMetrics.totalChargesPeriod < 0.01 && currentPeriodFilteredData.filter(row => (row[EXPECTED_COLUMNS.CHARGES] || 0) > 0).length === 0) { alert("No charges data to display for the selected period."); return; } chargesDetailsPopupTitleElement.textContent = `Charges Details (Period)`; chargesDetailsPopupSummaryElement.textContent = `Total Charges for Period: ${formatCurrency(currentMetrics.totalChargesPeriod)}`; const chargesItems = currentPeriodFilteredData.filter(row => (row[EXPECTED_COLUMNS.CHARGES] || 0) > 0).map(row => ({ customer: row[EXPECTED_COLUMNS.CUSTOMER], invDate: row.jsDate, chargeAmount: Number(row[EXPECTED_COLUMNS.CHARGES]) })).sort((a,b) => b.chargeAmount - a.chargeAmount); const tableData = chargesItems.map(item => [item.customer, item.invDate, item.chargeAmount]); updateTable('chargesDetailsTableBody', tableData, [ {}, { formatter: formatDate }, { formatter: (val) => formatCurrency(Number(val)), className: 'numeric' } ]); showPopup(chargesDetailsPopupElement);    }
    
    function showActiveClientsPopup() {
        if (currentMetrics.activeClientList.length === 0) {
            alert("No active clients in the selected period.");
            return;
        }
        activeClientsPopupSummaryElement.textContent = `Showing ${currentMetrics.activeClientsPeriodCount} unique clients active in this period.`;
        const tableData = currentMetrics.activeClientList.map(client => [client]);
        updateTable('activeClientsTableBody', tableData, [{}]);
        showPopup(activeClientsPopupElement);
    }

    function handleInvoiceChartBarClick(type) { 
        const invoiceChartDetailsPopupTitleElement = document.querySelector('#invoiceChartDetailsPopup .popup-header h4');
        const invoiceChartDetailsPopupSummaryElement = document.querySelector('#invoiceChartDetailsPopup .popup-summary');
        if (currentPeriodFilteredData.length === 0) { alert(`No data to display details for ${type} for the selected period.`); return; } 
        let detailsData = []; let summaryText = ""; let popupTitle = ""; 
        if (type === 'Invoices') { popupTitle = `All Invoice Details (Period)`; detailsData = currentPeriodFilteredData; summaryText = `Total Invoices in Period: ${currentMetrics.invoiceCount}`; } 
        else if (type === 'Softex') { popupTitle = `Softex Invoice Details (Period)`; detailsData = currentPeriodFilteredData.filter(row => row[EXPECTED_COLUMNS.SOFTEX] === 1); summaryText = `Total Invoices with Softex in Period: ${currentMetrics.softexCount}`; } 
        else if (type === 'BRC') { popupTitle = `BRC Invoice Details (Period)`; detailsData = currentPeriodFilteredData.filter(row => row[EXPECTED_COLUMNS.BRC] === 1); summaryText = `Total Invoices with BRC in Period: ${currentMetrics.brcCount}`; } 
        else { return; } 
        
        invoiceChartDetailsPopupTitleElement.textContent = popupTitle; 
        invoiceChartDetailsPopupSummaryElement.textContent = summaryText; 
        const tableData = detailsData.map(row => [ 
            row[EXPECTED_COLUMNS.INVOICE_NO], 
            row[EXPECTED_COLUMNS.CUSTOMER], 
            row.jsDate, 
            row[EXPECTED_COLUMNS.INVOICE_VALUE], 
            row[EXPECTED_COLUMNS.SOFTEX + '_VALUE'], 
            row[EXPECTED_COLUMNS.BRC + '_VALUE'] 
        ]); 
        updateTable('invoiceChartDetailsTableBody', tableData, [ 
            { formatter: formatNullableString }, 
            { formatter: formatNullableString }, 
            { formatter: formatDate }, 
            { formatter: formatCurrency, className: 'numeric' }, 
            { formatter: formatNullableString }, 
            { formatter: formatNullableString }
        ]); 
        showPopup(invoiceChartDetailsPopupElement);    
    }

    function updateDashboardUI(metrics) { 
        const updateText = (id, value) => { 
            const elem = document.getElementById(id); 
            if (elem) elem.innerText = value; 
            else console.warn(`Element with ID '${id}' not found.`); 
        }; 
        updateText('totalSalesYear', formatCurrency(metrics.totalSalesYear)); 
        const salesVsYearElem = document.getElementById('salesVsLastYear'); 
        if (salesVsYearElem) { const percentChangeFY = formatPercentage(metrics.totalSalesYear, metrics.previousFyTotalSales); salesVsYearElem.innerHTML = `${metrics.salesVsLastYearAmount >= 0 ? '▲' : '▼'} ${formatCurrency(Math.abs(metrics.salesVsLastYearAmount))} (${percentChangeFY}) vs last FY`; salesVsYearElem.className = metrics.salesVsLastYearAmount >= 0 ? 'highlight' : 'down'; } 
        updateText('totalSalesMonth', formatCurrency(metrics.totalSalesMonth)); 
        const salesVsMonthElem = document.getElementById('salesVsLastMonth'); 
        if (salesVsMonthElem) { const percentChangeM = formatPercentage(metrics.totalSalesMonth, metrics.previousMonthTotalSales); salesVsMonthElem.innerHTML = `${metrics.salesVsLastMonthAmount >= 0 ? '▲' : '▼'} ${formatCurrency(Math.abs(metrics.salesVsLastMonthAmount))} (${percentChangeM}) vs last month`; salesVsMonthElem.className = metrics.salesVsLastMonthAmount >= 0 ? 'highlight' : 'down'; } 
        
        updateTable('salesByCustomerTable', metrics.salesByCustomerPeriod.slice(0, 10).map(item => [item[0], item[1]]), [{}, { formatter: formatCurrency, className: 'numeric'}]); 
        
        updateText('cashFlowTotalPeriod', formatCurrency(metrics.totalReceivedPeriod)); 
        updateTable('cashFlowCustomerTable', metrics.cashFlowByCustomerPeriod.slice(0, 5).map(item => [item[0], item[1]]), [{}, { formatter: formatCurrency, className: 'numeric'}]); 
        updateText('outstandingTotal', formatCurrency(metrics.outstandingTotalPeriod)); 
        updateText('avgAgeing', `Avg Age: ${metrics.avgAgeing} days`); 
        if (invoiceChart) { invoiceChart.data.datasets[0].data = [metrics.invoiceCount, metrics.softexCount, metrics.brcCount]; invoiceChart.update(); } 
        updateText('activeClientsPeriod', metrics.activeClientsPeriodCount); 
        if (activeClientsChart) { activeClientsChart.data.datasets[0].data = [ metrics.totalClientsHistoricalCount, metrics.activeClientsPeriodCount ]; activeClientsChart.update(); } 
        const topRevenueTableData = metrics.topRevenuePeriod.map(item => [item.customer, item.revenue, item.contribution]); 
        updateTable('topRevenueTable', topRevenueTableData, [ {}, {formatter: formatCurrency, className: 'numeric'}, {formatter: (val) => `${val.toFixed(1)}%`, className: 'numeric'} ]); 
        updateText('totalCharges', formatCurrency(metrics.totalChargesPeriod)); 
        if (subsidiariesChart) { if (metrics.subsidiarySales.length > 0) { subsidiariesChart.data.labels = metrics.subsidiarySales.map(item => item[0]); subsidiariesChart.data.datasets[0].data = metrics.subsidiarySales.map(item => item[1]); } else { subsidiariesChart.data.labels = ['N/A']; subsidiariesChart.data.datasets[0].data = [0]; } subsidiariesChart.update(); } 
        const outstandingClientTableData = metrics.outstandingByClientFromDueColumn.slice(0, 6); 
        updateTable('outstandingByClientTable', outstandingClientTableData.map(item => [item[0], item[1]]), [{}, {formatter: formatCurrency, className: 'numeric'}]); 
    }

    function refreshDashboard() { 
        if (allFinancialData.length === 0) { 
            const emptyMetrics = { totalSalesYear: 0, salesVsLastYearAmount: 0, previousFyTotalSales: 0, totalSalesMonth: 0, salesVsLastMonthAmount: 0, previousMonthTotalSales: 0, totalSalesPeriod: 0, totalReceivedPeriod: 0, salesByCustomerPeriod: [], cashFlowByCustomerPeriod: [], outstandingTotalPeriod: 0, avgAgeing: 0, invoiceCount: 0, softexCount: 0, brcCount: 0, activeClientsPeriodCount: 0, totalClientsHistoricalCount: 0, topRevenuePeriod: [], totalChargesPeriod: 0, subsidiarySales: [], outstandingByClientFromDueColumn: [], activeClientList: [] }; 
            currentPeriodFilteredData = []; 
            currentMetrics = emptyMetrics; 
            updateDashboardUI(emptyMetrics); 
            if (invoiceChart) { invoiceChart.data.datasets[0].data = [0,0,0]; invoiceChart.update(); } 
            if (activeClientsChart) { activeClientsChart.data.datasets[0].data=[0,0]; activeClientsChart.update(); } 
            if (subsidiariesChart) { subsidiariesChart.data.labels=[]; subsidiariesChart.data.datasets[0].data=[]; subsidiariesChart.update(); } 
            return; 
        } 
        currentPeriodFilteredData = filterData(); 
        currentMetrics = calculateMetrics(currentPeriodFilteredData, allFinancialData); 
        updateDashboardUI(currentMetrics);    
    }

    document.addEventListener('DOMContentLoaded', () => { 
        initializeCharts(); 
        fySalesClientPopupElement = document.getElementById('fySalesClientPopup');
        monthSalesClientPopupElement = document.getElementById('monthSalesClientPopup');
        periodOutstandingPopupElement = document.getElementById('periodOutstandingPopup');
        chargesDetailsPopupElement = document.getElementById('chargesDetailsPopup');
        invoiceChartDetailsPopupElement = document.getElementById('invoiceChartDetailsPopup');
        periodOutstandingPopupTitleElement = document.querySelector('#periodOutstandingPopup .popup-header h4');
        periodOutstandingPopupSummaryElement = document.querySelector('#periodOutstandingPopup .popup-summary');
        periodOutstandingTableContainerElement = document.getElementById('periodOutstandingTableContainer');
        
        activeClientsPopupElement = document.getElementById('activeClientsPopup');
        activeClientsPopupSummaryElement = document.querySelector('#activeClientsPopup .popup-summary');

        document.getElementById('totalSalesYear')?.addEventListener('click', showFySalesDetailsPopup); 
        document.getElementById('totalSalesMonth')?.addEventListener('click', showMonthSalesDetailsPopup); 
        document.getElementById('outstandingTotal')?.addEventListener('click', showPeriodOutstandingDetailsPopup); 
        document.getElementById('totalCharges')?.addEventListener('click', showChargesDetailsPopup); 
        document.getElementById('activeClientsPeriod')?.addEventListener('click', showActiveClientsPopup);

        const allPopups = document.querySelectorAll('.popup-container'); 
        allPopups.forEach(popup => { 
            const closeButton = popup.querySelector('.popup-close-btn'); 
            if (closeButton) { closeButton.addEventListener('click', () => hidePopup(popup)); } 
            popup.addEventListener('click', (event) => { if (event.target === popup) { hidePopup(popup); } }); 
        }); 
        
        refreshDashboard();
        
        // Try to restore global authentication state and auto-load data
        tryRestoreGlobalAuthForDashboard();
        
        // Initialize the app and try to load data automatically
        initializeApp();
    });

    document.getElementById('file-upload')?.addEventListener('change', handleFileUpload);
    document.getElementById('year')?.addEventListener('change', refreshDashboard);
    document.getElementById('month')?.addEventListener('change', refreshDashboard);

    // Try to restore global authentication state and auto-load dashboard data
    async function tryRestoreGlobalAuthForDashboard() {
      try {
        // Load saved authentication state
        const savedAuthState = loadAuthState();
        
        if (savedAuthState) {
          console.log('Attempting to restore authentication state for dashboard...');
          
          // Check if user is still authenticated in MSAL
          const accounts = msalInstance.getAllAccounts();
          const savedAccount = accounts.find(acc => acc.homeAccountId === savedAuthState.accountId);
          
          if (savedAccount) {
            console.log('Found matching MSAL account, attempting silent token acquisition...');
            
            // Try to get token silently
            const tokenRequest = {
              scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
              account: savedAccount
            };
            
            const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
            
            // Restore global auth state
            globalAuth.isAuthenticated = true;
            globalAuth.accessToken = tokenResponse.accessToken;
            globalAuth.account = savedAccount;
            globalAuth.userName = savedAuthState.userName;
            
            // Update UI
            updateHeaderUI();
            
            // Auto-load dashboard data
            await loadDashboardData();
            
            console.log('Dashboard authentication state restored successfully');
            return;
          }
        }
        
        // No valid authentication state found
        console.log('No valid authentication state found for dashboard, showing initial state');
        updateHeaderUI();
        
      } catch (error) {
        console.log('Failed to restore authentication state for dashboard:', error.message);
        
        // Clear invalid state and show initial UI
        localStorage.removeItem(AUTH_STATE_KEY);
        globalAuth.isAuthenticated = false;
        updateHeaderUI();
      }
    }
  </script>
</body>
</html>