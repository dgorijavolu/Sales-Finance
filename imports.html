<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Imports Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- jQuery and DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  
  <!-- DataTables Extensions -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

  <!-- SheetJS (for Excel parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>

  <!--  MSAL.js for authentication Microsoft Graph API -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>   
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">   
  
  <!-- Centralized Configuration -->
  <script src="config.js"></script>   
  
  <style>
    /* Header styles */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      padding: 5px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #FFFFFF;
      font-size: 14px;
    }

    .user-info i {
      color: #27ae60;
    }

    .sign-in-btn, .sign-out-btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .sign-in-btn:hover, .sign-out-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
    }

    .sign-out-btn {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .sign-out-btn:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
      box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
    }

    /* Main content styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #2c3e50;
      color: #FFFFFF;
      min-height: 100vh;
      margin: 0;
      padding-top: 45px;
    }

    .container {
      width: 100%;
      margin: 0;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .upload-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    .upload-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Status message */
    .status-message {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }

    .status-loading {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }

    .status-success {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
    }

    .status-error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }

    /* Data Table */
    .data-table-container {
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.95) 0%, rgba(52, 73, 94, 0.95) 100%);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-title {
      font-size: 24px;
      font-weight: 600;
      color: #FFFFFF;
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .table-title i {
      color: #27ae60;
      font-size: 26px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .data-table th {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      color: #FFFFFF;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #FFFFFF;
      font-size: 14px;
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .data-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }

      .filter-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .filter-group {
        justify-content: space-between;
        width: 100%;
      }

      .filter-select {
        min-width: 100px;
        flex: 1;
        max-width: 150px;
      }
    }

    /* Loading animation */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Filter controls */
    .filter-controls {
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.95) 0%, rgba(52, 73, 94, 0.95) 100%);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .filter-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      flex: 1;
    }

    /* Summary tiles */
    .summary-tiles {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .summary-tile {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.2) 0%, rgba(46, 204, 113, 0.1) 100%);
      border: 1px solid rgba(39, 174, 96, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
      text-align: center;
      min-width: 120px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .summary-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
    }

    .summary-tile-label {
      font-size: 12px;
      color: #BDC3C7;
      margin-bottom: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-tile-value {
      font-size: 18px;
      font-weight: bold;
      color: #27ae60;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    /* Responsive design for summary tiles */
    @media (max-width: 768px) {
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-left {
        width: 100%;
        justify-content: space-between;
      }

      .summary-tiles {
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }

      .summary-tile {
        min-width: auto;
        width: 100%;
      }

      .filter-group {
        width: 100%;
        justify-content: space-between;
      }
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      color: #FFFFFF;
      font-weight: 500;
      font-size: 14px;
      white-space: nowrap;
    }

    .filter-select {
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #FFFFFF;
      padding: 8px 12px;
      font-size: 14px;
      min-width: 120px;
      transition: all 0.3s ease;
    }

    .filter-select:focus {
      border-color: #27ae60;
      outline: none;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
    }

    .filter-select option {
      background: #2c3e50;
      color: #FFFFFF;
    }

    /* Initial message */
    .initial-message {
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.9) 0%, rgba(52, 73, 94, 0.9) 100%);
      border-radius: 20px;
      margin: 0 0 30px 0;
      border: 2px dashed rgba(39, 174, 96, 0.3);
    }

    .initial-message i {
      font-size: 64px;
      color: #27ae60;
      margin-bottom: 20px;
      display: block;
    }

    .initial-message h2 {
      font-size: 28px;
      margin-bottom: 15px;
      color: #FFFFFF;
    }

    .initial-message p {
      font-size: 16px;
      color: #BDC3C7;
      line-height: 1.6;
    }

    /* DataTables Custom Styling */
    .dataTables_wrapper {
      background: rgba(52, 73, 94, 0.9);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }

    .dataTables_filter input {
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #FFFFFF;
      padding: 8px 12px;
    }

    .dataTables_filter input::placeholder {
      color: #BDC3C7;
    }

    .dataTables_length select {
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #FFFFFF;
      padding: 5px 10px;
    }

    .dataTables_info, .dataTables_filter label, .dataTables_length label {
      color: #FFFFFF !important;
    }

    #importsTable {
      background: rgba(44, 62, 80, 0.9);
      border-radius: 10px;
      overflow: hidden;
    }

    #importsTable thead th {
      background: #D5EDDA;
      color: #2c3e50;
      border: none;
      padding: 15px 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      border-bottom: 2px solid #27ae60;
    }

    #importsTable tbody td {
      background: rgba(52, 73, 94, 0.9);
      color: #FFFFFF;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px;
      font-size: 13px;
    }

    #importsTable tbody tr:hover td {
      background: rgba(39, 174, 96, 0.2);
    }

    .dt-buttons {
      margin-bottom: 15px;
    }

    .dt-button {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
      border: none !important;
      color: #FFFFFF !important;
      padding: 8px 15px !important;
      border-radius: 5px !important;
      margin-right: 5px !important;
      font-size: 12px !important;
      box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3) !important;
    }

    .dt-button:hover {
      background: linear-gradient(135deg, #229954 0%, #27ae60 100%) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4) !important;
    }

    /* Enhanced Pagination Styling */
    .dataTables_paginate {
      margin-top: 20px;
      text-align: center;
      background: transparent !important;
      border: none !important;
    }

    .dataTables_paginate .paginate_button {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
      border: 1px solid #27ae60 !important;
      color: #FFFFFF !important;
      margin: 0 3px !important;
      border-radius: 6px !important;
      padding: 8px 12px !important;
      font-size: 13px !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3) !important;
      display: inline-block !important;
    }

    .dataTables_paginate .paginate_button:hover {
      background: linear-gradient(135deg, #229954 0%, #27ae60 100%) !important;
      border-color: #229954 !important;
      color: #FFFFFF !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4) !important;
    }

    .dataTables_paginate .paginate_button.current {
      background: linear-gradient(135deg, #1e8449 0%, #239b56 100%) !important;
      border-color: #1e8449 !important;
      color: #FFFFFF !important;
      box-shadow: 0 4px 8px rgba(30, 132, 73, 0.5) !important;
    }

    .dataTables_paginate .paginate_button.disabled {
      background: rgba(52, 73, 94, 0.5) !important;
      border-color: rgba(255, 255, 255, 0.1) !important;
      color: rgba(255, 255, 255, 0.4) !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: none !important;
    }

    /* Fix for pagination container */
    .dataTables_info {
      background: transparent !important;
    }

    .dataTables_length {
      background: transparent !important;
    }

    .dataTables_filter {
      background: transparent !important;
    }
  </style>
</head>

<body>
  <!-- Top Header with Sign In -->
  <div class="top-header">
    <div class="header-left">
      <!-- Title removed to match other pages -->
    </div>
    <div class="header-right">
      <div id="userInfo" class="user-info" style="display: none;">
        <i class="fas fa-user"></i>
        <span id="userName">User</span>
      </div>
      <button id="signOutBtn" class="sign-out-btn" onclick="globalSignOut()" style="display: none;">
        <i class="fas fa-sign-out-alt"></i>
        Sign Out
      </button>
      <button class="upload-btn" onclick="getData()">
        <i class="fas fa-download"></i>
        Get Data
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Status Message -->
    <div id="statusMessage" class="status-message"></div>

    <!-- Initial Message -->
    <div id="initialMessage" class="initial-message">
      <i class="fas fa-ship"></i>
      <h2>Imports Dashboard</h2>
      <p>Click "Get Data" to load imports information from the IMPORTS sheet.<br>
         This dashboard will display comprehensive import data and analytics.</p>
    </div>

    <!-- Data Table -->
    <div id="tableContainer" class="data-table-container" style="display: none;">
      <!-- Summary Info -->
      <div id="summaryInfo" class="filter-controls">
        <div class="filter-left">
          <!-- Removed Total Records section -->
        </div>
        <!-- Summary Tiles -->
        <div class="summary-tiles">
          <div class="summary-tile">
            <div class="summary-tile-label">Total QTY</div>
            <div class="summary-tile-value">
              <i class="fas fa-boxes"></i>
              <span id="totalQty">0</span>
            </div>
          </div>
          <div class="summary-tile">
            <div class="summary-tile-label">Total Value</div>
            <div class="summary-tile-value">
              <i class="fas fa-dollar-sign"></i>
              <span id="totalValue">0</span>
            </div>
          </div>
        </div>
      </div>
      
      <table id="importsTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
          <tr id="tableHeaders">
            <!-- Headers will be populated dynamically -->
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be populated dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // MSAL Configuration - Use centralized config
    const msalConfig = window.FinanceDashboardConfig.msalConfig;

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Global authentication variables - Use centralized config
    let globalAuth = {
      isAuthenticated: false,
      accessToken: null,
      account: null,
      userName: null
    };

    // Use centralized configuration
    const config = window.FinanceDashboardConfig;
    const AUTH_STATE_KEY = config.authConfig.stateKey;
    const TARGET_FILE_NAME = config.getPrimaryFileName();
    const ALTERNATIVE_FILE_NAMES = config.getFileSearchNames();
    const TARGET_SHEET_NAME = config.getSheetName('imports');
    const FILEOWNER_EMAIL = config.getOwnerEmail();
    const BUTTON_TEXT = config.buttonText;

    // Data variables
    let currentData = null;
    let allImportsData = null; // Store complete dataset for filtering

    // Global sign-in function - Same as other pages
    async function globalSignIn() {
      try {
        updateButtonText(BUTTON_TEXT.SIGNING_IN);
        showStatus('loading', 'Signing in...');
        
        const loginRequest = {
          scopes: ['User.Read', 'Files.Read', 'Files.Read.All', 'Sites.Read.All']
        };
        
        const response = await msalInstance.loginPopup(loginRequest);
        
        // Get access token
        const tokenRequest = {
          scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
          account: response.account
        };
        const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
        
        // Update global auth state
        globalAuth.isAuthenticated = true;
        globalAuth.accessToken = tokenResponse.accessToken;
        globalAuth.account = response.account;
        globalAuth.userName = response.account.name || response.account.username;
        
        // Save authentication state
        saveAuthState();
        
        // Update UI
        updateHeaderUI();
        
        // Load data
        await loadImportsData();
        
        showStatus('success', 'Signed in successfully! Data loaded.');
        
      } catch (error) {
        console.error('Sign-in failed:', error);
        showStatus('error', 'Sign-in failed: ' + error.message);
        updateButtonText(BUTTON_TEXT.GET_DATA);
      }
    }

    // Global sign-out function - Same as other pages
    async function globalSignOut() {
      try {
        showStatus('loading', 'Signing out...');
        
        // Clear MSAL cache
        await msalInstance.logoutPopup();
        
        // Clear global auth state
        globalAuth.isAuthenticated = false;
        globalAuth.accessToken = null;
        globalAuth.account = null;
        globalAuth.userName = null;
        
        // Clear localStorage
        localStorage.removeItem(AUTH_STATE_KEY);
        
        // Update UI
        updateHeaderUI();
        
        // Clear data and reset UI
        currentData = null;
        showInitialMessage();
        updateButtonText(BUTTON_TEXT.GET_DATA);
        
        showStatus('success', 'Signed out successfully.');
        
      } catch (error) {
        console.error('Sign-out failed:', error);
        showStatus('error', 'Sign-out failed: ' + error.message);
      }
    }

    // Save authentication state to localStorage
    function saveAuthState() {
      const authState = {
        isAuthenticated: globalAuth.isAuthenticated,
        userName: globalAuth.userName,
        accountId: globalAuth.account?.homeAccountId,
        timestamp: Date.now()
      };
      localStorage.setItem(AUTH_STATE_KEY, JSON.stringify(authState));
    }

    // Load authentication state from localStorage
    function loadAuthState() {
      try {
        const saved = localStorage.getItem(AUTH_STATE_KEY);
        if (saved) {
          const authState = JSON.parse(saved);
          
          // Check if not expired (24 hours)
          const isExpired = (Date.now() - authState.timestamp) > (24 * 60 * 60 * 1000);
          
          if (!isExpired && authState.isAuthenticated) {
            return authState;
          } else {
            localStorage.removeItem(AUTH_STATE_KEY);
          }
        }
      } catch (error) {
        localStorage.removeItem(AUTH_STATE_KEY);
      }
      return null;
    }

    // Update header UI based on authentication state
    function updateHeaderUI() {
      const signOutBtn = document.getElementById('signOutBtn');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      
      if (globalAuth.isAuthenticated) {
        signOutBtn.style.display = 'block';
        userInfo.style.display = 'flex';
        userName.textContent = globalAuth.userName || 'User';
      } else {
        signOutBtn.style.display = 'none';
        userInfo.style.display = 'none';
      }
    }

    // Main data loading function
    async function getData() {
      try {
        if (!globalAuth.isAuthenticated) {
          await globalSignIn();
        } else {
          await loadImportsData();
        }
      } catch (error) {
        console.error('Error in getData:', error);
        showStatus('error', 'Failed to get data: ' + error.message);
        updateButtonText(BUTTON_TEXT.GET_DATA);
      }
    }

    // Load imports data
    async function loadImportsData() {
      try {
        if (!globalAuth.isAuthenticated || !globalAuth.accessToken) {
          throw new Error('Not authenticated');
        }
        
        updateButtonText(BUTTON_TEXT.LOADING_DATA);
        showStatus('loading', 'Loading imports data...');
        
        const fileData = await findAndLoadExcelFile(globalAuth.accessToken, TARGET_FILE_NAME, TARGET_SHEET_NAME);
        
        if (fileData) {
          currentData = fileData;
          processAndDisplayImportsData(fileData);
          showStatus('success', 'Imports data loaded successfully');
          updateButtonText(BUTTON_TEXT.REFRESH);
        } else {
          showStatus('error', 'Excel file not found in OneDrive');
          updateButtonText(BUTTON_TEXT.GET_DATA);
        }
        
      } catch (error) {
        console.error('Error loading imports data:', error);
        showStatus('error', 'Failed to load imports data: ' + error.message);
        updateButtonText(BUTTON_TEXT.GET_DATA);
      }
    }

    // Find and load Excel file - Enhanced logic like other pages
    async function findAndLoadExcelFile(accessToken, fileName, sheetName) {
      const headers = {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      };

      try {
        console.log(`Searching for file: ${fileName}`);
        
        // Get current user info
        let currentUserEmail = null;
        try {
          const userInfoResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            currentUserEmail = userInfo.mail || userInfo.userPrincipalName;
            console.log("Current user email:", currentUserEmail);
          }
        } catch (error) {
          console.log("Could not get current user info:", error.message);
        }
        
        // Determine if current user is the file owner
        const isFileOwner = currentUserEmail && currentUserEmail.toLowerCase() === FILEOWNER_EMAIL.toLowerCase();
        
        if (isFileOwner) {
          console.log("Current user is the file owner - searching in their own drive first");
          
          // Method 1: Search in current user's drive (for file owner)
          try {
            console.log("Searching in current user's drive");
            const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${fileName}')`;
            const searchResponse = await fetch(searchUrl, { headers });
            
            if (searchResponse.ok) {
              const searchResults = await searchResponse.json();
              const file = searchResults.value?.find(item => 
                item.name === fileName && item.file
              );
              
              if (file) {
                console.log("Found file in current user's drive:", file.name);
                return await processExcelFileFromDrive(accessToken, file.id, sheetName);
              }
            }
          } catch (error) {
            console.log("File owner's drive search failed:", error.message);
          }
        } else {
          console.log("Current user is NOT the file owner - searching in shared items first");
          
          // Method 2: Search in shared items - for users who received the file
          try {
            const sharedItemsUrl = `https://graph.microsoft.com/v1.0/me/drive/sharedWithMe`;
            console.log("Fetching shared items from:", sharedItemsUrl);
            
            const sharedResponse = await fetch(sharedItemsUrl, { headers });
            
            if (sharedResponse.ok) {
              const sharedData = await sharedResponse.json();
              console.log("Shared items found:", sharedData.value?.length || 0);
              console.log("All shared items names:", sharedData.value?.map(item => `"${item.name}"`));
              
              // Try to find file with any of the alternative names
              let targetFile = null;
              let matchedFileName = null;
              
              for (const altFileName of ALTERNATIVE_FILE_NAMES) {
                console.log(`Looking for: "${altFileName}"`);
                targetFile = sharedData.value?.find(item => 
                  item.name === altFileName && item.file
                );
                if (targetFile) {
                  matchedFileName = altFileName;
                  console.log(`Found file with name: "${matchedFileName}"`);
                  break;
                }
              }
              
              // If exact match fails, try case-insensitive match
              if (!targetFile) {
                console.log("Exact match failed, trying case-insensitive match");
                for (const altFileName of ALTERNATIVE_FILE_NAMES) {
                  targetFile = sharedData.value?.find(item => 
                    item.name?.toLowerCase() === altFileName.toLowerCase() && item.file
                  );
                  if (targetFile) {
                    matchedFileName = altFileName;
                    console.log(`Found file with case-insensitive match: "${targetFile.name}"`);
                    break;
                  }
                }
              }
              
              // If still no match, try partial match
              if (!targetFile) {
                console.log("Case-insensitive match failed, trying partial match");
                targetFile = sharedData.value?.find(item => 
                  item.name?.includes("Sample Data") && item.file
                );
                if (targetFile) {
                  console.log(`Found file with partial match: "${targetFile.name}"`);
                }
              }
              
              if (targetFile) {
                console.log("Found target file in shared items:", targetFile.name);
                return await processExcelFileFromSharedDrive(accessToken, targetFile, sheetName);
              } else {
                console.log("File not found in shared items.");
                console.log("Available file names:", sharedData.value?.filter(item => item.file).map(item => item.name));
              }
            } else {
              console.error("Failed to fetch shared items:", sharedResponse.status, sharedResponse.statusText);
              const errorText = await sharedResponse.text();
              console.error("Error response:", errorText);
            }
          } catch (error) {
            console.error("Shared items method failed:", error);
          }
          
          // Fallback: Try searching in current user's drive (maybe they have a copy)
          try {
            console.log("Fallback: Trying to search in current user's drive for a copy");
            const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${fileName}')`;
            const searchResponse = await fetch(searchUrl, { headers });
            
            if (searchResponse.ok) {
              const searchResults = await searchResponse.json();
              console.log("Search results in user's drive:", searchResults.value?.length || 0);
              console.log("Files found in search:", searchResults.value?.map(item => item.name));
              
              const file = searchResults.value?.find(item => 
                item.name === fileName && item.file
              );
              
              if (file) {
                console.log("Found file copy in current user's drive:", file.name);
                return await processExcelFileFromDrive(accessToken, file.id, sheetName);
              }
            }
          } catch (error) {
            console.log("Current user drive search failed:", error.message);
          }
          
          // Additional fallback: Try different search approaches
          try {
            console.log("Additional fallback: Searching for files with partial name match");
            const partialSearchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='Sample Data')`;
            const partialSearchResponse = await fetch(partialSearchUrl, { headers });
            
            if (partialSearchResponse.ok) {
              const partialResults = await partialSearchResponse.json();
              console.log("Partial search results:", partialResults.value?.length || 0);
              console.log("Files found in partial search:", partialResults.value?.map(item => item.name));
              
              const partialFile = partialResults.value?.find(item => 
                item.name?.includes("Sample Data") && item.file
              );
              
              if (partialFile) {
                console.log("Found file with partial search:", partialFile.name);
                return await processExcelFileFromDrive(accessToken, partialFile.id, sheetName);
              }
            }
          } catch (error) {
            console.log("Partial search failed:", error.message);
          }
        }
        
        // If all methods fail, provide detailed error message
        const errorMsg = `File not found. Please check:\n\n1. File exists in colleague's OneDrive\n2. File is shared with your account\n3. You have appropriate permissions\n4. File name is exactly correct\n\nTIP: Check browser console (F12) for detailed logs about what files were found.`;
        
        showStatus('error', 'File not found. Check console for details.');
        throw new Error(errorMsg);
        
      } catch (error) {
        console.error('Error finding/loading Excel file:', error);
        return null;
      }
    }

    // Process Excel file from drive
    async function processExcelFileFromDrive(accessToken, fileId, sheetName) {
      try {
        const fileUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`;
        const fileResponse = await fetch(fileUrl, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (fileResponse.ok) {
          const arrayBuffer = await fileResponse.arrayBuffer();
          return processDownloadedExcelFile(arrayBuffer, sheetName);
        }
      } catch (error) {
        console.error("File download failed:", error);
      }
      return null;
    }

    // Process Excel file from shared drive
    async function processExcelFileFromSharedDrive(accessToken, targetFile, sheetName) {
      try {
        const fileContentUrl = `https://graph.microsoft.com/v1.0/drives/${targetFile.remoteItem.parentReference.driveId}/items/${targetFile.remoteItem.id}/content`;
        const fileResponse = await fetch(fileContentUrl, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (fileResponse.ok) {
          const arrayBuffer = await fileResponse.arrayBuffer();
          return processDownloadedExcelFile(arrayBuffer, sheetName);
        }
      } catch (error) {
        console.error("Shared file download failed:", error);
      }
      return null;
    }

    // Process downloaded Excel file
    function processDownloadedExcelFile(arrayBuffer, sheetName) {
      try {
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        // Look for the specific sheet name
        let worksheet;
        if (workbook.SheetNames.includes(sheetName)) {
          worksheet = workbook.Sheets[sheetName];
        } else {
          // Try case-insensitive search
          const foundSheetName = workbook.SheetNames.find(name => 
            name.toLowerCase() === sheetName.toLowerCase()
          );
          if (foundSheetName) {
            worksheet = workbook.Sheets[foundSheetName];
          } else {
            throw new Error(`Sheet '${sheetName}' not found in the Excel file. Available sheets: ${workbook.SheetNames.join(', ')}`);
          }
        }
        
        // First, get raw data as array of arrays to find the header row
        const rawData = XLSX.utils.sheet_to_json(worksheet, { 
          header: 1, // Get as array of arrays
          raw: true, 
          defval: ''
        });
        
        console.log('=== RAW EXCEL DATA DEBUG ===');
        console.log('Total rows found:', rawData.length);
        console.log('First 5 rows:');
        rawData.slice(0, 5).forEach((row, index) => {
          console.log(`Row ${index}:`, row);
        });
        
        // Find the actual header row (skip empty rows and rows with mostly empty values)
        let headerRowIndex = -1;
        let headers = [];
        
        for (let i = 0; i < Math.min(10, rawData.length); i++) { // Check first 10 rows
          const row = rawData[i];
          if (row && row.length > 0) {
            // Check if this row has meaningful headers (not empty or __EMPTY patterns)
            const nonEmptyValues = row.filter(cell => 
              cell !== null && 
              cell !== undefined && 
              cell !== '' && 
              !String(cell).includes('__EMPTY')
            );
            
            // If we find a row with several meaningful values, use it as headers
            if (nonEmptyValues.length >= 3) {
              headerRowIndex = i;
              headers = row.map((header, index) => {
                if (header && header !== '' && !String(header).includes('__EMPTY')) {
                  return String(header).trim();
                } else {
                  return `Column_${index + 1}`;
                }
              });
              console.log(`Found header row at index ${i}:`, headers);
              break;
            }
          }
        }
        
        if (headerRowIndex === -1) {
          throw new Error('Could not find a valid header row in the Excel sheet');
        }
        
        // Get data rows (everything after the header row)
        const dataRows = rawData.slice(headerRowIndex + 1);
        
        // Clean up headers - replace # with S.no and other improvements
        const cleanedHeaders = headers.map(header => {
          if (header === '#' || header === 'No.' || header === 'No' || header.toLowerCase() === 'number') {
            return 'S.no';
          }
          return header;
        });
        
        // Convert to objects using the cleaned headers
        const processedData = dataRows
          .filter(row => row && row.some(cell => cell !== null && cell !== undefined && cell !== '')) // Skip empty rows
          .map(row => {
            const obj = {};
            cleanedHeaders.forEach((header, index) => {
              obj[header] = row[index] || '';
            });
            return obj;
          });
        
        console.log('=== PROCESSED DATA DEBUG ===');
        console.log('Header row index:', headerRowIndex);
        console.log('Original headers:', headers);
        console.log('Cleaned headers:', cleanedHeaders);
        console.log('Processed data rows:', processedData.length);
        console.log('First 3 processed rows:', processedData.slice(0, 3));
        console.log('=== END DEBUG ===');
        
        return processedData;
        
      } catch (error) {
        console.error("Error processing Excel file:", error);
        throw error;
      }
    }

    // Process and display imports data
    function processAndDisplayImportsData(data) {
      if (!data || data.length === 0) {
        showStatus('error', 'No data found in the IMPORTS sheet');
        return;
      }

      // Store all data (no filtering needed)
      allImportsData = data;

      // Debug: Log data structure for troubleshooting
      console.log('=== IMPORTS DATA ANALYSIS ===');
      console.log('Total records loaded:', data.length);
      console.log('Column names:', Object.keys(data[0]));
      console.log('First 3 rows of data:');
      data.slice(0, 3).forEach((row, index) => {
        console.log(`Row ${index + 1}:`, row);
      });
      console.log('=== END DATA ANALYSIS ===');

      // Hide initial message and show table container
      document.getElementById('initialMessage').style.display = 'none';
      document.getElementById('tableContainer').style.display = 'block';

      // Create table with all data (no filtering)
      createImportsTable(data);
      updateRecordCount(data.length);
    }

    // Excel date conversion function
    function excelDateToJSDate(excelDate) {
      // Excel dates are stored as days since January 1, 1900
      // JavaScript Date uses milliseconds since January 1, 1970
      const excelEpoch = new Date(1900, 0, 1); // January 1, 1900
      const jsDate = new Date(excelEpoch.getTime() + (excelDate - 1) * 24 * 60 * 60 * 1000);
      return jsDate;
    }

    // Format cell value based on column type
    function formatCellValue(value, columnName) {
      if (value === null || value === undefined || value === '') {
        return 'N/A';
      }

      const columnLower = columnName.toLowerCase();
      
      // Special handling for Year column - convert Excel date serial numbers to years
      if (columnLower.includes('year')) {
        // If it's a number that looks like an Excel date serial number
        if (typeof value === 'number' && value > 1000 && value < 100000) {
          try {
            const date = excelDateToJSDate(value);
            // Validate the date is reasonable (between 1900 and 2100)
            if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
              return date.getFullYear().toString();
            }
          } catch (e) {
            console.log('Year conversion failed for value:', value);
          }
        }
        // If it's already a 4-digit year, return as is
        if (typeof value === 'number' && value >= 1900 && value <= 2100) {
          return value.toString();
        }
        // If it's a string that contains a year
        const yearMatch = value.toString().match(/\b(19|20)\d{2}\b/);
        if (yearMatch) {
          return yearMatch[0];
        }
      }
      
      // Check if this is a date column and the value looks like an Excel date serial number
      if ((columnLower.includes('date') || columnLower.includes('time')) && 
          typeof value === 'number' && value > 1 && value < 100000) {
        try {
          const date = excelDateToJSDate(value);
          // Validate the date is reasonable (between 1900 and 2100)
          if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            });
          }
        } catch (e) {
          console.log('Date conversion failed for value:', value);
        }
      }
      
      // Format currency values
      if (typeof value === 'number' && 
          (columnLower.includes('amount') || columnLower.includes('value') || 
           columnLower.includes('total') || columnLower.includes('cost') || columnLower.includes('price'))) {
        return '$' + value.toLocaleString();
      }
      
      return value.toString();
    }

    // Calculate summary statistics from the data
    function calculateAndUpdateSummary(data) {
      let totalQty = 0;
      let totalValue = 0;

      if (!data || data.length === 0) {
        updateSummaryTiles(0, 0);
        return;
      }

      // Get column headers
      const headers = Object.keys(data[0]);
      
      // Find QTY columns
      const qtyColumns = headers.filter(header => {
        const headerLower = header.toLowerCase();
        return headerLower.includes('qty') || 
               headerLower.includes('quantity') ||
               headerLower === 'qty';
      });

      // Find value/amount columns
      const valueColumns = headers.filter(header => {
        const headerLower = header.toLowerCase();
        return headerLower.includes('value') || 
               headerLower.includes('amount') ||
               headerLower.includes('cost') ||
               headerLower.includes('price') ||
               headerLower.includes('total');
      });

      console.log('QTY columns found:', qtyColumns);
      console.log('Value columns found:', valueColumns);

      // Calculate totals
      data.forEach(row => {
        // Sum QTY columns
        qtyColumns.forEach(column => {
          const value = row[column];
          if (value !== null && value !== undefined && value !== '') {
            const numValue = parseFloat(String(value).replace(/[^\d.-]/g, ''));
            if (!isNaN(numValue) && isFinite(numValue)) {
              totalQty += numValue;
            }
          }
        });

        // Sum all value columns
        valueColumns.forEach(column => {
          const value = row[column];
          if (value !== null && value !== undefined && value !== '') {
            const numValue = parseFloat(String(value).replace(/[^\d.-]/g, ''));
            if (!isNaN(numValue) && isFinite(numValue)) {
              totalValue += numValue;
            }
          }
        });
      });

      console.log('Calculated Total QTY:', totalQty);
      console.log('Calculated Total Value:', totalValue);

      updateSummaryTiles(totalQty, totalValue);
    }

    // Update the summary tiles display
    function updateSummaryTiles(totalQty, totalValue) {
      const qtyElement = document.getElementById('totalQty');
      const valueElement = document.getElementById('totalValue');

      if (qtyElement) {
        qtyElement.textContent = totalQty.toLocaleString();
      }

      if (valueElement) {
        valueElement.textContent = totalValue.toLocaleString();
      }
    }

    // Create imports table with DataTables
    function createImportsTable(data) {
      // Destroy existing DataTable if it exists
      if ($.fn.DataTable.isDataTable('#importsTable')) {
        $('#importsTable').DataTable().destroy();
      }

      const tableHeaders = document.getElementById('tableHeaders');
      const tableBody = document.getElementById('tableBody');
      
      // Clear existing content
      tableHeaders.innerHTML = '';
      tableBody.innerHTML = '';

      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #BDC3C7;">No data available</td></tr>';
        updateSummaryTiles(0, 0); // Reset summary when no data
        return;
      }

      // Calculate and update summary
      calculateAndUpdateSummary(data);

      // Create headers
      const headers = Object.keys(data[0]);
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHeaders.appendChild(th);
      });

      // Process and add all data rows (DataTables will handle pagination)
      data.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          const formattedValue = formatCellValue(row[header], header);
          td.textContent = formattedValue;
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });

      // Initialize DataTable with advanced features
      $('#importsTable').DataTable({
        responsive: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        dom: 'Blfrtip',
        buttons: [
          {
            extend: 'excel', 
            text: '<i class="fas fa-file-excel"></i> Excel',
            className: 'btn-sm'
          },
          {
            extend: 'pdf',
            text: '<i class="fas fa-file-pdf"></i> PDF', 
            className: 'btn-sm'
          }
        ],
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Search imports...",
          lengthMenu: "Show _MENU_ records per page",
          info: "Showing _START_ to _END_ of _TOTAL_ records",
          infoEmpty: "No records available",
          infoFiltered: "(filtered from _MAX_ total records)",
          paginate: {
            first: "First",
            last: "Last", 
            next: "Next",
            previous: "Previous"
          }
        },
        order: [[0, 'asc']], // Default sort by first column
        columnDefs: [
          {
            targets: '_all',
            className: 'text-center'
          }
        ],
        initComplete: function() {
          console.log('DataTable initialized with', data.length, 'records');
          // Add custom styling after initialization
          $('.dataTables_filter input').attr('placeholder', 'Search all columns...');
        }
      });
    }

    // Update record count display
    function updateRecordCount(count) {
      const recordCountElement = document.getElementById('recordCount');
      if (recordCountElement) {
        recordCountElement.innerHTML = `<i class="fas fa-info-circle"></i> Total Records: ${count}`;
      }
    }

    // Utility functions
    function updateButtonText(text) {
      const button = document.querySelector('.upload-btn');
      if (button) {
        if (text === BUTTON_TEXT.LOADING_DATA) {
          button.innerHTML = '<div class="loading-spinner"></div>' + text;
        } else if (text === BUTTON_TEXT.REFRESH) {
          button.innerHTML = '<i class="fas fa-sync-alt"></i>' + text;
        } else {
          button.innerHTML = text;
        }
      }
    }

    function showStatus(type, message) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = `status-message status-${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    function showInitialMessage() {
      document.getElementById('initialMessage').style.display = 'block';
      document.getElementById('tableContainer').style.display = 'none';
      
      // Reset data variables
      allImportsData = null;
      currentData = null;
    }

    // Try to restore authentication state on page load
    async function tryRestoreGlobalAuth() {
      try {
        const savedAuthState = loadAuthState();
        
        if (savedAuthState) {
          const accounts = msalInstance.getAllAccounts();
          const savedAccount = accounts.find(acc => acc.homeAccountId === savedAuthState.accountId);
          
          if (savedAccount) {
            const tokenRequest = {
              scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
              account: savedAccount
            };
            
            const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
            
            globalAuth.isAuthenticated = true;
            globalAuth.accessToken = tokenResponse.accessToken;
            globalAuth.account = savedAccount;
            globalAuth.userName = savedAuthState.userName;
            
            updateHeaderUI();
            await loadImportsData();
            return;
          }
        }
        
        showInitialMessage();
        updateButtonText(BUTTON_TEXT.GET_DATA);
        updateHeaderUI();
        
      } catch (error) {
        console.log('Failed to restore authentication state:', error.message);
        localStorage.removeItem(AUTH_STATE_KEY);
        globalAuth.isAuthenticated = false;
        showInitialMessage();
        updateButtonText(BUTTON_TEXT.GET_DATA);
        updateHeaderUI();
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      tryRestoreGlobalAuth();
    });
  </script>
</body>
</html>
