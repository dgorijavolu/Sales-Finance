<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Write-Off Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- jQuery and DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  
  <!-- DataTables Extensions -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

  <!-- SheetJS (for Excel parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>

  <!--  MSAL.js for authentication Microsoft Graph API -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>   
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">   
  
  <!-- Centralized Configuration -->
  <script src="config.js"></script>   
  
  <style>
    /* Header styles */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      padding: 5px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #FFFFFF;
      font-size: 14px;
    }

    .user-info i {
      color: #f39c12;
    }

    .sign-in-btn, .sign-out-btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .sign-in-btn:hover, .sign-out-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
    }

    .sign-out-btn {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .sign-out-btn:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
      box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
    }

    /* Main content styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #2c3e50;
      color: #FFFFFF;
      min-height: 100vh;
      margin: 0;
      padding-top: 45px;
    }

    .container {
      width: 100%;
      margin: 0;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .upload-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    .upload-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Status message */
    .status-message {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }

    .status-loading {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }

    .status-success {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
    }

    .status-error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }

    /* Data Table */
    .data-table-container {
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.95) 0%, rgba(52, 73, 94, 0.95) 100%);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-title {
      font-size: 24px;
      font-weight: 600;
      color: #FFFFFF;
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .table-title i {
      color: #e74c3c;
      font-size: 26px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .data-table th {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: #FFFFFF;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #FFFFFF;
      font-size: 15px;
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .data-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }

      .filter-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .filter-group {
        justify-content: space-between;
        width: 100%;
      }

      .filter-select {
        min-width: 100px;
        flex: 1;
        max-width: 150px;
      }
    }

    /* Loading animation */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Filter controls */
    .filter-controls {
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.95) 0%, rgba(52, 73, 94, 0.95) 100%);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .filter-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      flex: 1;
    }

    /* Total tiles */
    .total-tiles {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .total-tile {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      text-align: center;
      min-width: 120px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .total-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .total-tile-label {
      font-size: 12px;
      color: #BDC3C7;
      margin-bottom: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .total-tile-value {
      font-size: 18px;
      font-weight: bold;
      color: #FFFFFF;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .usd-tile .total-tile-value {
      color: #2ecc71;
    }

    .inr-tile .total-tile-value {
      color: #f39c12;
    }

    /* Responsive design for total tiles */
    @media (max-width: 768px) {
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-left {
        width: 100%;
        justify-content: space-between;
      }

      .total-tiles {
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }

      .total-tile {
        min-width: auto;
        width: 100%;
      }

      .filter-group {
        width: 100%;
        justify-content: space-between;
      }
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      color: #FFFFFF;
      font-weight: 500;
      font-size: 14px;
      white-space: nowrap;
    }

    .filter-select {
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #FFFFFF;
      padding: 8px 12px;
      font-size: 14px;
      min-width: 120px;
      transition: all 0.3s ease;
    }

    .filter-select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .filter-select option {
      background: #2c3e50;
      color: #FFFFFF;
    }

    /* Initial message */
    .initial-message {
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(135deg, rgba(44, 62, 80, 0.9) 0%, rgba(52, 73, 94, 0.9) 100%);
      border-radius: 20px;
      margin: 0 0 30px 0;
      border: 2px dashed rgba(231, 76, 60, 0.3);
    }

    .initial-message i {
      font-size: 64px;
      color: #e74c3c;
      margin-bottom: 20px;
      display: block;
    }

    .initial-message h2 {
      font-size: 28px;
      margin-bottom: 15px;
      color: #FFFFFF;
    }

    .initial-message p {
      font-size: 16px;
      color: #BDC3C7;
      line-height: 1.6;
    }

    /* DataTables Pagination and Info Styling */
    .dataTables_wrapper .dataTables_paginate {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-top: 20px;
      font-size: 18px;
      gap: 10px;
      width: 100%;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      background: #f39c12;
      border: 2px solid #e67e22;
      color: #fff !important;
      font-size: 18px;
      margin: 0 6px;
      padding: 6px 18px;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s, border 0.2s;
      cursor: pointer;
      min-width: 38px;
      min-height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(243, 156, 18, 0.08);
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: #e67e22;
      color: #fff !important;
      font-weight: bold;
      border: 2px solid #f39c12;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(230, 126, 34, 0.15);
      outline: none;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current) {
      background: #e67e22;
      color: #fff !important;
      border: 2px solid #f39c12;
      box-shadow: 0 2px 8px rgba(230, 126, 34, 0.12);
    }
    .dataTables_wrapper .dataTables_paginate .ellipsis {
      color: #fff;
      font-size: 20px;
      margin: 0 8px;
    }
    .dataTables_wrapper .dataTables_info {
      color: #BDC3C7;
      font-size: 16px;
      text-align: left;
      margin-bottom: 10px;
      margin-top: 10px;
    }
    /* Remove default list style for pagination */
    .dataTables_wrapper .dataTables_paginate ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 0;
    }
    /* Hide bullet points for pagination */
    .dataTables_wrapper .dataTables_paginate ul li {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    /* Hide DataTables default background on disabled buttons */
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
      color: #888 !important;
      background: none !important;
      cursor: not-allowed !important;
      opacity: 0.5;
    }
    /* Responsive: pagination font smaller on mobile */
    @media (max-width: 768px) {
      .dataTables_wrapper .dataTables_paginate {
        font-size: 14px;
      }
      .dataTables_wrapper .dataTables_paginate .paginate_button {
        font-size: 14px;
        padding: 4px 8px;
      }
      .dataTables_wrapper .dataTables_info {
        font-size: 13px;
      }
    }

    .dataTables_filter input {
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #FFFFFF;
      padding: 8px 12px;
    }

    .dataTables_filter input::placeholder {
      color: #BDC3C7;
    }

    .dataTables_length select {
      background: rgba(44, 62, 80, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #FFFFFF;
      padding: 5px 10px;
    }

    .dataTables_info, .dataTables_filter label, .dataTables_length label {
      color: #FFFFFF !important;
    }

    /* Use data-table class styles instead */

  /* Remove custom #writeOffTable thead th styles to use .data-table th (orange) */

    /* Use orange DataTables theme styles defined above */

    /* Remove conflicting old styles - use the orange theme from above */
  </style>
</head>

<body>
  <!-- Top Header with Sign In -->
  <div class="top-header">
    <div class="header-left">
      <!-- Title removed to match other pages -->
    </div>
    <div class="header-right">
      <div id="userInfo" class="user-info" style="display: none;">
        <i class="fas fa-user"></i>
        <span id="userName">User</span>
      </div>
      <button id="signOutBtn" class="sign-out-btn" onclick="globalSignOut()" style="display: none;">
        <i class="fas fa-sign-out-alt"></i>
        Sign Out
      </button>
      <button class="upload-btn" onclick="getData()">
        <i class="fas fa-download"></i>
        Get Data
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Status Message -->
    <div id="statusMessage" class="status-message"></div>

    <!-- Initial Message -->
    <div id="initialMessage" class="initial-message">
      <i class="fas fa-minus-circle"></i>
      <h2>Write-Off Data</h2>
      <p>Click "Get Data" to load write-off information from the WRITE-OFF sheet.<br>
         This information will display write-off data in a detailed table.</p>
    </div>

    <!-- Data Table -->
    <div id="tableContainer" class="data-table-container" style="display: none;">
      <!-- Filter Controls -->
      <div id="filterControls" class="filter-controls">
        <div class="filter-left">
          <div class="filter-group">
            <label for="yearFilter"><i class="fas fa-calendar-alt"></i> Filter by Year:</label>
            <select id="yearFilter" class="filter-select" onchange="filterDataByYear()">
              <option value="all">All Years</option>
            </select>
          </div>
          <div class="filter-group">
            <span id="recordCount" style="color: #BDC3C7; font-size: 13px;">
              <i class="fas fa-info-circle"></i> Total Records: 0
            </span>
          </div>
        </div>
        <!-- Total Tiles -->
        <div class="total-tiles">
          <div class="total-tile usd-tile">
            <div class="total-tile-label">USD Total</div>
            <div class="total-tile-value">
              <i class="fas fa-dollar-sign"></i>
              <span id="usdTotal">0</span>
            </div>
          </div>
          <div class="total-tile inr-tile">
            <div class="total-tile-label">INR Total</div>
            <div class="total-tile-value">
              <i class="fas fa-rupee-sign"></i>
              <span id="inrTotal">0</span>
            </div>
          </div>
        </div>
      </div>
      
      <table id="writeOffTable" class="data-table table table-striped table-bordered" style="width:100%">
        <thead>
          <tr id="tableHeaders">
            <!-- Headers will be populated dynamically -->
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be populated dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // MSAL Configuration - Use centralized config
    const msalConfig = window.FinanceDashboardConfig.msalConfig;

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Global authentication variables - Use centralized config
    let globalAuth = {
      isAuthenticated: false,
      accessToken: null,
      account: null,
      userName: null
    };

    // Use centralized configuration
    const config = window.FinanceDashboardConfig;
    const AUTH_STATE_KEY = config.authConfig.stateKey;
    const TARGET_FILE_NAME = config.getPrimaryFileName();
    const ALTERNATIVE_FILE_NAMES = config.getFileSearchNames();
    const TARGET_SHEET_NAME = config.getSheetName('writeOff');
    const FILEOWNER_EMAIL = config.getOwnerEmail();
    const BUTTON_TEXT = config.buttonText;

    // Chart instance - removed since chart is not needed
    let currentData = null;
    let allWriteOffData = null; // Store complete dataset for filtering

    // Global sign-in function - Same as other pages
    async function globalSignIn() {
      try {
        updateButtonText(BUTTON_TEXT.SIGNING_IN);
        showStatus('loading', 'Signing in...');
        
        const loginRequest = {
          scopes: ['User.Read', 'Files.Read', 'Files.Read.All', 'Sites.Read.All']
        };
        
        const response = await msalInstance.loginPopup(loginRequest);
        
        // Get access token
        const tokenRequest = {
          scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
          account: response.account
        };
        const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
        
        // Update global auth state
        globalAuth.isAuthenticated = true;
        globalAuth.accessToken = tokenResponse.accessToken;
        globalAuth.account = response.account;
        globalAuth.userName = response.account.name || response.account.username;
        
        // Save authentication state
        saveAuthState();
        
        // Update UI
        updateHeaderUI();
        
        // Load data
        await loadWriteOffData();
        
        showStatus('success', 'Signed in successfully! Data loaded.');
        
      } catch (error) {
        console.error('Sign-in failed:', error);
        showStatus('error', 'Sign-in failed: ' + error.message);
        updateButtonText(BUTTON_TEXT.GET_DATA);
      }
    }

    // Global sign-out function - Same as other pages
    async function globalSignOut() {
      try {
        showStatus('loading', 'Signing out...');
        
        // Clear MSAL cache
        await msalInstance.logoutPopup();
        
        // Clear global auth state
        globalAuth.isAuthenticated = false;
        globalAuth.accessToken = null;
        globalAuth.account = null;
        globalAuth.userName = null;
        
        // Clear localStorage
        localStorage.removeItem(AUTH_STATE_KEY);
        
        // Update UI
        updateHeaderUI();
        
        // Clear data and reset UI
        currentData = null;
        showInitialMessage();
        updateButtonText(BUTTON_TEXT.GET_DATA);
        
        showStatus('success', 'Signed out successfully.');
        
      } catch (error) {
        console.error('Sign-out failed:', error);
        showStatus('error', 'Sign-out failed: ' + error.message);
      }
    }

    // Save authentication state to localStorage
    function saveAuthState() {
      const authState = {
        isAuthenticated: globalAuth.isAuthenticated,
        userName: globalAuth.userName,
        accountId: globalAuth.account?.homeAccountId,
        timestamp: Date.now()
      };
      localStorage.setItem(AUTH_STATE_KEY, JSON.stringify(authState));
    }

    // Load authentication state from localStorage
    function loadAuthState() {
      try {
        const saved = localStorage.getItem(AUTH_STATE_KEY);
        if (saved) {
          const authState = JSON.parse(saved);
          
          // Check if not expired (24 hours)
          const isExpired = (Date.now() - authState.timestamp) > (24 * 60 * 60 * 1000);
          
          if (!isExpired && authState.isAuthenticated) {
            return authState;
          } else {
            localStorage.removeItem(AUTH_STATE_KEY);
          }
        }
      } catch (error) {
        localStorage.removeItem(AUTH_STATE_KEY);
      }
      return null;
    }

    // Update header UI based on authentication state
    function updateHeaderUI() {
      const signOutBtn = document.getElementById('signOutBtn');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      
      if (globalAuth.isAuthenticated) {
        signOutBtn.style.display = 'block';
        userInfo.style.display = 'flex';
        userName.textContent = globalAuth.userName || 'User';
      } else {
        signOutBtn.style.display = 'none';
        userInfo.style.display = 'none';
      }
    }

    // Main data loading function
    async function getData() {
      try {
        if (!globalAuth.isAuthenticated) {
          await globalSignIn();
        } else {
          await loadWriteOffData();
        }
      } catch (error) {
        console.error('Error in getData:', error);
        showStatus('error', 'Failed to get data: ' + error.message);
        updateButtonText(BUTTON_TEXT.GET_DATA);
      }
    }

    // Load write-off data
    async function loadWriteOffData() {
      try {
        if (!globalAuth.isAuthenticated || !globalAuth.accessToken) {
          throw new Error('Not authenticated');
        }
        
        updateButtonText(BUTTON_TEXT.LOADING_DATA);
        showStatus('loading', 'Loading write-off data...');
        
        const fileData = await findAndLoadExcelFile(globalAuth.accessToken, TARGET_FILE_NAME, TARGET_SHEET_NAME);
        
        if (fileData) {
          currentData = fileData;
          processAndDisplayWriteOffData(fileData);
          showStatus('success', 'Write-off data loaded successfully');
          updateButtonText(BUTTON_TEXT.REFRESH);
        } else {
          showStatus('error', 'Excel file not found in OneDrive');
          updateButtonText(BUTTON_TEXT.GET_DATA);
        }
        
      } catch (error) {
        console.error('Error loading write-off data:', error);
        showStatus('error', 'Failed to load write-off data: ' + error.message);
        updateButtonText(BUTTON_TEXT.GET_DATA);
      }
    }

    // Find and load Excel file - Enhanced logic like dashboard and softex-brc
    async function findAndLoadExcelFile(accessToken, fileName, sheetName) {
      const headers = {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      };

      try {
        console.log(`Searching for file: ${fileName}`);
        
        // Get current user info
        let currentUserEmail = null;
        try {
          const userInfoResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            currentUserEmail = userInfo.mail || userInfo.userPrincipalName;
            console.log("Current user email:", currentUserEmail);
          }
        } catch (error) {
          console.log("Could not get current user info:", error.message);
        }
        
        // Determine if current user is the file owner
        const isFileOwner = currentUserEmail && currentUserEmail.toLowerCase() === FILEOWNER_EMAIL.toLowerCase();
        
        if (isFileOwner) {
          console.log("Current user is the file owner - searching in their own drive first");
          
          // Method 1: Search in current user's drive (for file owner)
          try {
            console.log("Searching in current user's drive");
            const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${fileName}')`;
            const searchResponse = await fetch(searchUrl, { headers });
            
            if (searchResponse.ok) {
              const searchResults = await searchResponse.json();
              const file = searchResults.value?.find(item => 
                item.name === fileName && item.file
              );
              
              if (file) {
                console.log("Found file in current user's drive:", file.name);
                return await processExcelFileFromDrive(accessToken, file.id, sheetName);
              }
            }
          } catch (error) {
            console.log("File owner's drive search failed:", error.message);
          }
        } else {
          console.log("Current user is NOT the file owner - searching in shared items first");
          
          // Method 2: Search in shared items - for users who received the file
          try {
            const sharedItemsUrl = `https://graph.microsoft.com/v1.0/me/drive/sharedWithMe`;
            console.log("Fetching shared items from:", sharedItemsUrl);
            
            const sharedResponse = await fetch(sharedItemsUrl, { headers });
            
            if (sharedResponse.ok) {
              const sharedData = await sharedResponse.json();
              console.log("Shared items found:", sharedData.value?.length || 0);
              console.log("All shared items names:", sharedData.value?.map(item => `"${item.name}"`));
              
              // Try to find file with any of the alternative names
              let targetFile = null;
              let matchedFileName = null;
              
              for (const altFileName of ALTERNATIVE_FILE_NAMES) {
                console.log(`Looking for: "${altFileName}"`);
                targetFile = sharedData.value?.find(item => 
                  item.name === altFileName && item.file
                );
                if (targetFile) {
                  matchedFileName = altFileName;
                  console.log(`Found file with name: "${matchedFileName}"`);
                  break;
                }
              }
              
              // If exact match fails, try case-insensitive match
              if (!targetFile) {
                console.log("Exact match failed, trying case-insensitive match");
                for (const altFileName of ALTERNATIVE_FILE_NAMES) {
                  targetFile = sharedData.value?.find(item => 
                    item.name?.toLowerCase() === altFileName.toLowerCase() && item.file
                  );
                  if (targetFile) {
                    matchedFileName = altFileName;
                    console.log(`Found file with case-insensitive match: "${targetFile.name}"`);
                    break;
                  }
                }
              }
              
              // If still no match, try partial match
              if (!targetFile) {
                console.log("Case-insensitive match failed, trying partial match");
                targetFile = sharedData.value?.find(item => 
                  item.name?.includes("EDIS") && item.name?.includes("DB-Test") && item.file
                );
                if (targetFile) {
                  console.log(`Found file with partial match: "${targetFile.name}"`);
                }
              }
              
              if (targetFile) {
                console.log("Found target file in shared items:", targetFile.name);
                return await processExcelFileFromSharedDrive(accessToken, targetFile, sheetName);
              } else {
                console.log("File not found in shared items.");
                console.log("Available file names:", sharedData.value?.filter(item => item.file).map(item => item.name));
              }
            } else {
              console.error("Failed to fetch shared items:", sharedResponse.status, sharedResponse.statusText);
              const errorText = await sharedResponse.text();
              console.error("Error response:", errorText);
            }
          } catch (error) {
            console.error("Shared items method failed:", error);
          }
          
          // Fallback: Try searching in current user's drive (maybe they have a copy)
          try {
            console.log("Fallback: Trying to search in current user's drive for a copy");
            const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${fileName}')`;
            const searchResponse = await fetch(searchUrl, { headers });
            
            if (searchResponse.ok) {
              const searchResults = await searchResponse.json();
              console.log("Search results in user's drive:", searchResults.value?.length || 0);
              console.log("Files found in search:", searchResults.value?.map(item => item.name));
              
              const file = searchResults.value?.find(item => 
                item.name === fileName && item.file
              );
              
              if (file) {
                console.log("Found file copy in current user's drive:", file.name);
                return await processExcelFileFromDrive(accessToken, file.id, sheetName);
              }
            }
          } catch (error) {
            console.log("Current user drive search failed:", error.message);
          }
          
          // Additional fallback: Try different search approaches
          try {
            console.log("Additional fallback: Searching for files with partial name match");
            const partialSearchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='EDIS DB-Test')`;
            const partialSearchResponse = await fetch(partialSearchUrl, { headers });
            
            if (partialSearchResponse.ok) {
              const partialResults = await partialSearchResponse.json();
              console.log("Partial search results:", partialResults.value?.length || 0);
              console.log("Files found in partial search:", partialResults.value?.map(item => item.name));
              
              const partialFile = partialResults.value?.find(item => 
                item.name?.includes("EDIS") && item.name?.includes("DB-Test") && item.file
              );
              
              if (partialFile) {
                console.log("Found file with partial search:", partialFile.name);
                return await processExcelFileFromDrive(accessToken, partialFile.id, sheetName);
              }
            }
          } catch (error) {
            console.log("Partial search failed:", error.message);
          }
        }
        
        // If all methods fail, provide detailed error message
        const errorMsg = `File not found. Please check:\n\n1. File exists in colleague's OneDrive\n2. File is shared with your account\n3. You have appropriate permissions\n4. File name is exactly correct\n\nTIP: Check browser console (F12) for detailed logs about what files were found.`;
        
        showStatus('error', 'File not found. Check console for details.');
        throw new Error(errorMsg);
        
      } catch (error) {
        console.error('Error finding/loading Excel file:', error);
        return null;
      }
    }

    // Process Excel file from drive
    async function processExcelFileFromDrive(accessToken, fileId, sheetName) {
      try {
        const fileUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`;
        const fileResponse = await fetch(fileUrl, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (fileResponse.ok) {
          const arrayBuffer = await fileResponse.arrayBuffer();
          return processDownloadedExcelFile(arrayBuffer, sheetName);
        }
      } catch (error) {
        console.error("File download failed:", error);
      }
      return null;
    }

    // Process Excel file from shared drive
    async function processExcelFileFromSharedDrive(accessToken, targetFile, sheetName) {
      try {
        const fileContentUrl = `https://graph.microsoft.com/v1.0/drives/${targetFile.remoteItem.parentReference.driveId}/items/${targetFile.remoteItem.id}/content`;
        const fileResponse = await fetch(fileContentUrl, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (fileResponse.ok) {
          const arrayBuffer = await fileResponse.arrayBuffer();
          return processDownloadedExcelFile(arrayBuffer, sheetName);
        }
      } catch (error) {
        console.error("Shared file download failed:", error);
      }
      return null;
    }

    // Process downloaded Excel file
    function processDownloadedExcelFile(arrayBuffer, sheetName) {
      try {
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        // Look for the specific sheet name
        let worksheet;
        if (workbook.SheetNames.includes(sheetName)) {
          worksheet = workbook.Sheets[sheetName];
        } else {
          // Try case-insensitive search
          const foundSheetName = workbook.SheetNames.find(name => 
            name.toLowerCase() === sheetName.toLowerCase()
          );
          if (foundSheetName) {
            worksheet = workbook.Sheets[foundSheetName];
          } else {
            throw new Error(`Sheet '${sheetName}' not found in the Excel file. Available sheets: ${workbook.SheetNames.join(', ')}`);
          }
        }
        
        // Convert to JSON
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: '' });
        return jsonData;
        
      } catch (error) {
        console.error("Error processing Excel file:", error);
        throw error;
      }
    }

    // Process and display write-off data
    function processAndDisplayWriteOffData(data) {
      if (!data || data.length === 0) {
        showStatus('error', 'No data found in the WRITE-OFF sheet');
        return;
      }

      // Store all data for filtering
      allWriteOffData = data;

      // Debug: Log data structure for troubleshooting
      console.log('=== WRITE-OFF DATA ANALYSIS ===');
      console.log('Total records loaded:', data.length);
      console.log('Column names:', Object.keys(data[0]));
      console.log('First 3 rows of data:');
      data.slice(0, 3).forEach((row, index) => {
        console.log(`Row ${index + 1}:`, row);
      });
      console.log('=== END DATA ANALYSIS ===');

      // Hide initial message and show table container
      document.getElementById('initialMessage').style.display = 'none';
      document.getElementById('tableContainer').style.display = 'block';

      // Populate year dropdown
      populateYearFilter(data);

      // Create table with all data initially
      createWriteOffTable(data);
      updateRecordCount(data.length);
    }

    // Excel date conversion function
    function excelDateToJSDate(excelDate) {
      // Excel dates are stored as days since January 1, 1900
      // JavaScript Date uses milliseconds since January 1, 1970
      const excelEpoch = new Date(1900, 0, 1); // January 1, 1900
      const jsDate = new Date(excelEpoch.getTime() + (excelDate - 1) * 24 * 60 * 60 * 1000);
      return jsDate;
    }

    // Format cell value based on column type
    function formatCellValue(value, columnName) {
      if (value === null || value === undefined || value === '') {
        return 'N/A';
      }

      const columnLower = columnName.toLowerCase();
      
      // Check if this is a date column and the value looks like an Excel date serial number
      if ((columnLower.includes('date') || columnLower.includes('time')) && 
          typeof value === 'number' && value > 1 && value < 100000) {
        try {
          const date = excelDateToJSDate(value);
          // Validate the date is reasonable (between 1900 and 2100)
          if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            });
          }
        } catch (e) {
          console.log('Date conversion failed for value:', value);
        }
      }
      
      // Format currency values
      if (typeof value === 'number' && 
          (columnLower.includes('amount') || columnLower.includes('value') || 
           columnLower.includes('total') || columnLower.includes('usd') || columnLower.includes('inr'))) {
        return '$' + value.toLocaleString();
      }
      
      return value.toString();
    }

    // Calculate USD and INR totals from the data
    function calculateAndUpdateTotals(data) {
      let usdTotal = 0;
      let inrTotal = 0;

      if (!data || data.length === 0) {
        updateTotalTiles(0, 0);
        return;
      }

      // Get column headers
      const headers = Object.keys(data[0]);
      
      // Find USD and INR columns
      const usdColumns = headers.filter(header => {
        const headerLower = header.toLowerCase();
        return headerLower.includes('usd') || 
               (headerLower.includes('value') && headerLower.includes('usd')) ||
               (headerLower.includes('amount') && headerLower.includes('usd')) ||
               headerLower.includes('invoice value in usd');
      });

      const inrColumns = headers.filter(header => {
        const headerLower = header.toLowerCase();
        return headerLower.includes('inr') || 
               (headerLower.includes('value') && headerLower.includes('inr')) ||
               (headerLower.includes('amount') && headerLower.includes('inr')) ||
               headerLower.includes('invoice value in inr');
      });

      console.log('USD columns found:', usdColumns);
      console.log('INR columns found:', inrColumns);

      // Calculate totals
      data.forEach(row => {
        // Sum USD values
        usdColumns.forEach(column => {
          const value = row[column];
          if (value !== null && value !== undefined && value !== '') {
            const numValue = parseFloat(String(value).replace(/[^\d.-]/g, ''));
            if (!isNaN(numValue) && isFinite(numValue)) {
              usdTotal += numValue;
            }
          }
        });

        // Sum INR values
        inrColumns.forEach(column => {
          const value = row[column];
          if (value !== null && value !== undefined && value !== '') {
            const numValue = parseFloat(String(value).replace(/[^\d.-]/g, ''));
            if (!isNaN(numValue) && isFinite(numValue)) {
              inrTotal += numValue;
            }
          }
        });
      });

      console.log('Calculated USD Total:', usdTotal);
      console.log('Calculated INR Total:', inrTotal);

      updateTotalTiles(usdTotal, inrTotal);
    }

    // Update the total tiles display
    function updateTotalTiles(usdTotal, inrTotal) {
      const usdElement = document.getElementById('usdTotal');
      const inrElement = document.getElementById('inrTotal');

      if (usdElement) {
        usdElement.textContent = usdTotal.toLocaleString();
      }

      if (inrElement) {
        inrElement.textContent = inrTotal.toLocaleString();
      }
    }

    // Create write-off table with DataTables
    function createWriteOffTable(data) {
      // Destroy existing DataTable if it exists
      if ($.fn.DataTable.isDataTable('#writeOffTable')) {
        $('#writeOffTable').DataTable().destroy();
      }

      const tableHeaders = document.getElementById('tableHeaders');
      const tableBody = document.getElementById('tableBody');
      
      // Clear existing content
      tableHeaders.innerHTML = '';
      tableBody.innerHTML = '';

      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #BDC3C7;">No data available</td></tr>';
        updateTotalTiles(0, 0); // Reset totals when no data
        return;
      }

      // Calculate and update totals
      calculateAndUpdateTotals(data);

      // Create headers
      const headers = Object.keys(data[0]);
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHeaders.appendChild(th);
      });

      // Process and add all data rows (DataTables will handle pagination)
      data.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          const formattedValue = formatCellValue(row[header], header);
          td.textContent = formattedValue;
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });

      // Initialize DataTable with advanced features
      $('#writeOffTable').DataTable({
        responsive: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        dom: 'Blfrtip',
        buttons: [
          {
            extend: 'excel', 
            text: '<i class="fas fa-file-excel"></i> Excel',
            className: 'btn-sm'
          },
          {
            extend: 'pdf',
            text: '<i class="fas fa-file-pdf"></i> PDF', 
            className: 'btn-sm'
          }
        ],
        language: {
          search: "_INPUT_",
          searchPlaceholder: "Search records...",
          lengthMenu: "Show _MENU_ records per page",
          info: "Showing _START_ to _END_ of _TOTAL_ records",
          infoEmpty: "No records available",
          infoFiltered: "(filtered from _MAX_ total records)",
          paginate: {
            first: "First",
            last: "Last", 
            next: "Next",
            previous: "Previous"
          }
        },
        order: [[0, 'asc']], // Default sort by first column
        columnDefs: [
          {
            targets: '_all',
            className: 'text-center'
          }
        ],
        initComplete: function() {
          console.log('DataTable initialized with', data.length, 'records');
          // Add custom styling after initialization
          $('.dataTables_filter input').attr('placeholder', 'Search all columns...');
        }
      });
    }

    // Populate year filter dropdown
    function populateYearFilter(data) {
      const yearFilter = document.getElementById('yearFilter');
      const fiscalYears = new Set();
      
      // Debug: Log all available columns
      if (data.length > 0) {
        const headers = Object.keys(data[0]);
        console.log('Available columns in write-off data:', headers);
        console.log('Sample row data:', data[0]);
        
        // Look ONLY for fiscal year patterns in the data (ignore everything else)
        data.forEach((row, index) => {
          headers.forEach(column => {
            const value = row[column];
            if (value != null && value !== '') {
              const valueStr = value.toString().trim();
              
              // ONLY Method: Look for fiscal year patterns like "2018-2019", "2021-2022", etc.
              const fiscalYearPattern = /\b(19|20)\d{2}[-\s]+(19|20)\d{2}\b/;
              const fiscalMatch = valueStr.match(fiscalYearPattern);
              if (fiscalMatch) {
                const fiscalYear = fiscalMatch[0].replace(/\s+/g, '-'); // Normalize spaces to dashes
                fiscalYears.add(fiscalYear);
                if (index < 3) console.log(`Found fiscal year in column "${column}":`, valueStr, '→', fiscalYear);
              }
              
              // NOTE: Removed all other year detection methods to show ONLY fiscal years
            }
          });
        });
      }
      
      // Clear existing options except "All Years"
      yearFilter.innerHTML = '<option value="all">All Years</option>';
      
      // Sort fiscal years properly
      const sortedFiscalYears = Array.from(fiscalYears).sort((a, b) => {
        // Extract the first year from each fiscal year for sorting
        const yearA = parseInt(a.match(/\b(19|20)\d{2}\b/)[0]);
        const yearB = parseInt(b.match(/\b(19|20)\d{2}\b/)[0]);
        return yearB - yearA; // Descending order (newest first)
      });
      
      // Add fiscal years to dropdown
      sortedFiscalYears.forEach(fiscalYear => {
        const option = document.createElement('option');
        option.value = fiscalYear;
        option.textContent = fiscalYear;
        yearFilter.appendChild(option);
      });
      
      console.log('Fiscal years found in write-off data:', sortedFiscalYears);
      
      if (sortedFiscalYears.length === 0) {
        console.warn('No fiscal years found in the data. Please check if your data contains fiscal year ranges like "2018-2019".');
        // Add a disabled option to show no years found
        const option = document.createElement('option');
        option.value = 'none';
        option.textContent = 'No fiscal years detected';
        option.disabled = true;
        yearFilter.appendChild(option);
      }
    }

    // Filter data by selected year
    function filterDataByYear() {
      const selectedYear = document.getElementById('yearFilter').value;
      
      if (!allWriteOffData) {
        console.warn('No data available for filtering');
        return;
      }
      
      console.log('Filtering data for fiscal year:', selectedYear);
      
      let filteredData = allWriteOffData;
      
      if (selectedYear !== 'all') {
        console.log('Target fiscal year for filtering:', selectedYear);
        
        filteredData = allWriteOffData.filter((row, index) => {
          const headers = Object.keys(row);
          
          // Check ALL columns for exact fiscal year matches ONLY
          const hasMatchingYear = headers.some(column => {
            const value = row[column];
            if (value == null || value === '') return false;
            
            const valueStr = value.toString().trim();
            
            // Method 1: Exact fiscal year match (e.g., "2018-2019")
            if (valueStr === selectedYear) {
              if (index < 5) console.log(`Row ${index} exact match: column "${column}" = "${valueStr}"`);
              return true;
            }
            
            // Method 2: Fiscal year pattern match with normalization
            const fiscalYearPattern = /\b(19|20)\d{2}[-\s]+(19|20)\d{2}\b/;
            const fiscalMatch = valueStr.match(fiscalYearPattern);
            if (fiscalMatch) {
              const normalizedFiscalYear = fiscalMatch[0].replace(/\s+/g, '-');
              if (normalizedFiscalYear === selectedYear) {
                if (index < 5) console.log(`Row ${index} normalized match: column "${column}" = "${valueStr}" → "${normalizedFiscalYear}"`);
                return true;
              }
            }
            
            // NOTE: Removed all other matching methods to focus ONLY on fiscal year ranges
            
            return false;
          });
          
          return hasMatchingYear;
        });
        
        console.log(`Original data: ${allWriteOffData.length} rows, Filtered data: ${filteredData.length} rows`);
        
        if (filteredData.length === 0) {
          console.warn(`No records found for fiscal year ${selectedYear}. Check if this fiscal year exists in the Excel file.`);
        }
      }
      
      // Recreate table with filtered data
      createWriteOffTable(filteredData);
      updateRecordCount(filteredData.length);
      
      // Show a status message about filtering
      if (selectedYear !== 'all') {
        if (filteredData.length > 0) {
          showStatus('success', `Showing ${filteredData.length} records for ${selectedYear}`);
        } else {
          showStatus('error', `No records found for ${selectedYear}`);
        }
      } else {
        showStatus('success', `Showing all ${filteredData.length} records`);
      }
    }

    // Update record count display
    function updateRecordCount(count) {
      const recordCountElement = document.getElementById('recordCount');
      if (recordCountElement) {
        recordCountElement.innerHTML = `<i class="fas fa-info-circle"></i> Total Records: ${count}`;
      }
    }

    // Debug function - call from browser console if needed
    window.debugWriteOffData = function() {
      if (!allWriteOffData) {
        console.log('No write-off data loaded yet');
        return;
      }
      
      console.log('=== MANUAL DEBUG ANALYSIS ===');
      console.log('Total records:', allWriteOffData.length);
      console.log('Columns:', Object.keys(allWriteOffData[0]));
      
      // Show first 5 rows with all their values
      console.log('First 5 rows:');
      allWriteOffData.slice(0, 5).forEach((row, index) => {
        console.log(`\nRow ${index + 1}:`);
        Object.keys(row).forEach(column => {
          console.log(`  ${column}: "${row[column]}" (${typeof row[column]})`);
        });
      });
      
      // Test fiscal year detection on first few rows
      console.log('\n=== FISCAL YEAR DETECTION TEST ===');
      allWriteOffData.slice(0, 5).forEach((row, index) => {
        console.log(`\nRow ${index + 1} fiscal year detection:`);
        Object.keys(row).forEach(column => {
          const value = row[column];
          if (value != null && value !== '') {
            const valueStr = value.toString().trim();
            
            // Check for fiscal year patterns
            const fiscalYearPattern = /\b(19|20)\d{2}[-\s]+(19|20)\d{2}\b/;
            const fiscalMatch = valueStr.match(fiscalYearPattern);
            if (fiscalMatch) {
              const fiscalYear = fiscalMatch[0].replace(/\s+/g, '-');
              console.log(`  ${column}: "${valueStr}" → FISCAL YEAR: ${fiscalYear}`);
            }
            // Check for single years
            else if (typeof value === 'number' && value >= 1900 && value <= 2100 && value.toString().length === 4) {
              console.log(`  ${column}: "${value}" → SINGLE YEAR: ${value}`);
            }
            // Check for Excel dates
            else if (typeof value === 'number' && value > 1 && value < 100000) {
              try {
                const date = excelDateToJSDate(value);
                if (date.getFullYear() >= 1900 && date.getFullYear() <= 2100) {
                  console.log(`  ${column}: "${value}" → EXCEL DATE YEAR: ${date.getFullYear()}`);
                }
              } catch (e) {
                // Skip
              }
            }
          }
        });
      });
      
      // Analyze unique fiscal years in the data
      console.log('\n=== UNIQUE FISCAL YEARS ANALYSIS ===');
      const fiscalYears = new Set();
      allWriteOffData.forEach(row => {
        Object.keys(row).forEach(column => {
          const value = row[column];
          if (value != null && value !== '') {
            const valueStr = value.toString().trim();
            const fiscalYearPattern = /\b(19|20)\d{2}[-\s]+(19|20)\d{2}\b/;
            const fiscalMatch = valueStr.match(fiscalYearPattern);
            if (fiscalMatch) {
              const fiscalYear = fiscalMatch[0].replace(/\s+/g, '-');
              fiscalYears.add(fiscalYear);
            }
          }
        });
      });
      
      console.log('All unique fiscal years found:', Array.from(fiscalYears).sort());
      console.log('=== END MANUAL DEBUG ===');
    };

    // Utility functions
    function updateButtonText(text) {
      const button = document.querySelector('.upload-btn');
      if (button) {
        if (text === BUTTON_TEXT.LOADING_DATA) {
          button.innerHTML = '<div class="loading-spinner"></div>' + text;
        } else if (text === BUTTON_TEXT.REFRESH) {
          button.innerHTML = '<i class="fas fa-sync-alt"></i>' + text;
        } else {
          button.innerHTML = text;
        }
      }
    }

    function showStatus(type, message) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = `status-message status-${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    function showInitialMessage() {
      document.getElementById('initialMessage').style.display = 'block';
      document.getElementById('tableContainer').style.display = 'none';
      
      // Reset data variables
      allWriteOffData = null;
      currentData = null;
    }

    // Try to restore authentication state on page load
    async function tryRestoreGlobalAuth() {
      try {
        const savedAuthState = loadAuthState();
        
        if (savedAuthState) {
          const accounts = msalInstance.getAllAccounts();
          const savedAccount = accounts.find(acc => acc.homeAccountId === savedAuthState.accountId);
          
          if (savedAccount) {
            const tokenRequest = {
              scopes: ['Files.Read', 'Files.Read.All', 'Sites.Read.All'],
              account: savedAccount
            };
            
            const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
            
            globalAuth.isAuthenticated = true;
            globalAuth.accessToken = tokenResponse.accessToken;
            globalAuth.account = savedAccount;
            globalAuth.userName = savedAuthState.userName;
            
            updateHeaderUI();
            await loadWriteOffData();
            return;
          }
        }
        
        showInitialMessage();
        updateButtonText(BUTTON_TEXT.GET_DATA);
        updateHeaderUI();
        
      } catch (error) {
        console.log('Failed to restore authentication state:', error.message);
        localStorage.removeItem(AUTH_STATE_KEY);
        globalAuth.isAuthenticated = false;
        showInitialMessage();
        updateButtonText(BUTTON_TEXT.GET_DATA);
        updateHeaderUI();
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      tryRestoreGlobalAuth();
    });
  </script>
</body>
</html>
